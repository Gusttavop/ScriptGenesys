// ==UserScript==
// @name Genesys Helper Suite & Timer
// @namespace http://your-domain.com/
// @version 4.0
// @description Sistema unificado: Cron√¥metro, Busca Doc e C√≥pia Instant√¢nea (Visual Ajustado).
// @author AI Assistant
// @match *://*/*
// @grant GM_addStyle

// =================================================================
// PARTE 1: CRON√îMETRO (Mantido original)
// =================================================================
(function() {
    // --- Configura√ß√µes ---
    const limitTimeMs = 60 * 1000;
    const updateIntervalMs = 10;
    const formatTime = num => String(num).padStart(2, '0');

    // Estilos para o cron√¥metro e n√∫mero da conversa
    const runningBgColor = 'rgba(255, 255, 255, 0.9)';
    const runningTextColor = 'black';
    const runningBorderColor = '#ccc';
    const runningBoxShadow = '0 1px 3px rgba(0,0,0,0.1)';

    const timerFontSize = '12px';
    const timerPadding = '2px 5px';
    const timerBorderRadius = '3px';

    const pausedBgColor = 'rgba(255, 255, 255, 0.9)';
    const pausedTextColor = 'red';
    const pausedBorderColor = '#ccc';
    const pausedBoxShadow = '0 1px 3px rgba(0,0,0,0.1)';

    const completedBgColor = 'rgba(0, 0, 0, 1)'; // Fundo preto s√≥lido
    const completedTextColor = 'lime'; // Cor verde para o checkmark
    const completedText = '‚úì';
    const completedFontSize = '20px';
    const completedPadding = '0px';
    const completedBorderRadius = '5px';

    const numberBgColor = runningBgColor;
    const numberTextColor = runningTextColor;
    const numberBorderColor = runningBorderColor;
    const numberBoxShadow = runningBoxShadow;
    const numberFontSize = '12px';
    const numberPadding = '2px 5px';
    const numberBorderRadius = '3px';

    const numberRightPosition = '5px';
    const numberTopPosition = '2px';

    const conversationTimers = new Map();
    let currentActiveConversationEl = null;

    // --- Fun√ß√µes de Controle de Cron√¥metro Individual ---
    function renderTime(timerDiv, elapsedTime, prefix = '') {
        let totalSeconds = Math.floor(elapsedTime / 1000);
        let minutes = Math.floor(totalSeconds / 60);
        let seconds = totalSeconds % 60;
        timerDiv.textContent = `${prefix}${formatTime(minutes)}:${formatTime(seconds)}`;
    }

    function pauseTimer(conversationEl) {
        const timerData = conversationTimers.get(conversationEl);
        if (timerData && !timerData.isPaused) {
            clearInterval(timerData.timerIntervalId);
            timerData.pausedAt = Date.now();
            timerData.isPaused = true;
            if (!timerData.timerDiv.classList.contains('timer-completed')) {
                timerData.timerDiv.style.backgroundColor = pausedBgColor;
                timerData.timerDiv.style.color = pausedTextColor;
                timerData.timerDiv.style.borderColor = pausedBorderColor;
                timerData.timerDiv.style.boxShadow = pausedBoxShadow;
            }
        }
    }

    function resumeTimer(conversationEl) {
        const timerData = conversationTimers.get(conversationEl);
        if (timerData && timerData.isPaused && !timerData.timerDiv.classList.contains('timer-completed')) {
            timerData.startTime += (Date.now() - timerData.pausedAt);
            timerData.isPaused = false;
            timerData.timerIntervalId = setInterval(() => updateIndividualTimer(conversationEl), updateIntervalMs);
            timerData.timerDiv.style.backgroundColor = runningBgColor;
            timerData.timerDiv.style.color = runningTextColor;
            timerData.timerDiv.style.borderColor = runningBorderColor;
            timerData.timerDiv.style.boxShadow = runningBoxShadow;
        }
    }

    function removeTimer(conversationEl) {
        const timerData = conversationTimers.get(conversationEl);
        if (timerData) {
            clearInterval(timerData.timerIntervalId);
            if (timerData.timerDiv && timerData.timerDiv.parentNode) {
                timerData.timerDiv.remove();
            }
            if (timerData.numberDiv && timerData.numberDiv.parentNode) {
                timerData.numberDiv.remove();
            }
            conversationTimers.delete(conversationEl);
        }
    }

    function updateIndividualTimer(conversationEl) {
        const timerData = conversationTimers.get(conversationEl);
        if (!timerData || timerData.isPaused) return;

        let elapsedTime = Date.now() - timerData.startTime;

        if (elapsedTime >= limitTimeMs) {
            clearInterval(timerData.timerIntervalId);
            timerData.timerDiv.textContent = completedText;
            timerData.timerDiv.style.backgroundColor = completedBgColor;
            timerData.timerDiv.style.color = completedTextColor;
            timerData.timerDiv.style.fontSize = completedFontSize;
            timerData.timerDiv.style.borderColor = 'transparent';
            timerData.timerDiv.style.boxShadow = 'none';
            timerData.isPaused = true;
            timerData.timerDiv.classList.add('timer-completed');

            timerData.timerDiv.style.top = '20%';
            timerData.timerDiv.style.right = '9px';
            timerData.timerDiv.style.left = 'auto';
            timerData.timerDiv.style.transform = 'translateY(-50%)';
            timerData.timerDiv.style.width = 'fit-content';
            timerData.timerDiv.style.textAlign = 'center';
            timerData.timerDiv.style.padding = completedPadding;
            timerData.timerDiv.style.borderRadius = completedBorderRadius;

            console.log(`Cron√¥metro da conversa (ID: ${conversationEl.id || 'N/A'}) conclu√≠do: ‚úì`);
            return;
        }
        renderTime(timerData.timerDiv, elapsedTime);
    }

    function createTimerAndNumberForConversation(conversationEl) {
        let existingTimerDivInDOM = conversationEl.querySelector('.injected-conversation-timer');
        let existingNumberDivInDOM = conversationEl.querySelector('.injected-conversation-number');

        if (existingTimerDivInDOM || existingNumberDivInDOM) {
            if (conversationTimers.has(conversationEl)) {
                const existingTimerData = conversationTimers.get(conversationEl);
                if (existingTimerData.timerDiv.classList.contains('timer-completed')) {
                    clearInterval(existingTimerData.timerIntervalId);
                    existingTimerData.startTime = Date.now();
                    existingTimerData.pausedAt = Date.now();
                    existingTimerData.isPaused = true;
                    renderTime(existingTimerData.timerDiv, 0);
                    existingTimerData.timerDiv.style.backgroundColor = pausedBgColor;
                    existingTimerData.timerDiv.style.color = pausedTextColor;
                    existingTimerData.timerDiv.style.fontSize = timerFontSize;
                    existingTimerData.timerDiv.style.borderColor = pausedBorderColor;
                    existingTimerData.timerDiv.style.boxShadow = pausedBoxShadow;
                    existingTimerData.timerDiv.classList.remove('timer-completed');
                    existingTimerData.timerDiv.style.padding = timerPadding;
                    existingTimerData.timerDiv.style.borderRadius = timerBorderRadius;

                    existingTimerData.timerDiv.style.top = '20%';
                    existingTimerData.timerDiv.style.right = '9px';
                    existingTimerData.timerDiv.style.left = 'auto';
                    existingTimerData.timerDiv.style.transform = 'translateY(-50%)';
                    existingTimerData.timerDiv.style.width = 'fit-content';
                    existingTimerData.timerDiv.style.textAlign = 'center';
                    existingTimerData.timerDiv.style.minWidth = '45px';

                    if (existingTimerData.numberDiv) {
                        existingTimerData.numberDiv.style.display = 'block';
                        existingTimerData.numberDiv.style.top = numberTopPosition;
                        existingTimerData.numberDiv.style.right = numberRightPosition;
                        existingTimerData.numberDiv.style.left = 'auto';
                        existingTimerData.numberDiv.style.transform = 'none';
                    }
                }
                return existingTimerData;
            } else {
                console.warn("Script: Encontrado timer/n√∫mero injetado '√≥rf√£o' no DOM para uma conversa. Removendo para recriar.");
                if (existingTimerDivInDOM) existingTimerDivInDOM.remove();
                if (existingNumberDivInDOM) existingNumberDivInDOM.remove();
            }
        }
        if (conversationTimers.has(conversationEl)) {
            return conversationTimers.get(conversationEl);
        }

        conversationEl.style.position = 'relative';

        let timerDiv = document.createElement('div');
        timerDiv.className = 'injected-conversation-timer';
        timerDiv.style.position = 'absolute';
        timerDiv.style.top = '20%';
        timerDiv.style.right = '9px';
        timerDiv.style.left = 'auto';
        timerDiv.style.transform = 'translateY(-50%)';
        timerDiv.style.backgroundColor = pausedBgColor;
        timerDiv.style.color = pausedTextColor;
        timerDiv.style.padding = timerPadding;
        timerDiv.style.borderRadius = timerBorderRadius;
        timerDiv.style.fontSize = timerFontSize;
        timerDiv.style.fontFamily = 'monospace';
        timerDiv.style.zIndex = '9999';
        timerDiv.style.width = 'fit-content';
        timerDiv.style.textAlign = 'center';
        timerDiv.style.border = `1px solid ${pausedBorderColor}`;
        timerDiv.style.boxShadow = pausedBoxShadow;
        timerDiv.style.fontWeight = 'bold';
        timerDiv.style.cursor = 'pointer';
        timerDiv.style.userSelect = 'none';
        timerDiv.style.minWidth = '45px';
        conversationEl.appendChild(timerDiv);

        function resetTimer(conversationEl) {
            const timerData = conversationTimers.get(conversationEl);
            if (!timerData) return;

            clearInterval(timerData.timerIntervalId);
            timerData.startTime = Date.now();
            timerData.pausedAt = Date.now();
            timerData.isPaused = true;

            timerData.timerDiv.classList.remove('timer-completed');
            timerData.timerDiv.style.backgroundColor = pausedBgColor;
            timerData.timerDiv.style.color = pausedTextColor;
            timerData.timerDiv.style.borderColor = pausedBorderColor;
            timerData.timerDiv.style.boxShadow = pausedBoxShadow;
            timerData.timerDiv.style.fontSize = timerFontSize;
            timerData.timerDiv.style.padding = timerPadding;
            timerData.timerDiv.style.borderRadius = timerBorderRadius;

            renderTime(timerData.timerDiv, 0);
        }

        timerDiv.ondblclick = () => {
            resetTimer(conversationEl);
        };
        
        let clickCount = 0;
        let clickTimeout = null;

        timerDiv.onclick = () => {
            clickCount++;

            if (clickCount === 3) {
                clearTimeout(clickTimeout);
                clickCount = 0;
                finalizeTimer(conversationEl);
            } else {
                if (clickTimeout) clearTimeout(clickTimeout);
                clickTimeout = setTimeout(() => {
                    clickCount = 0;
                }, 400);
            }
        };

        function finalizeTimer(conversationEl) {
            const timerData = conversationTimers.get(conversationEl);
            if (!timerData) return;

            clearInterval(timerData.timerIntervalId);
            timerData.timerDiv.textContent = '‚úî';
            timerData.timerDiv.classList.add('timer-completed');

            timerData.timerDiv.textContent = completedText;
            timerData.timerDiv.style.backgroundColor = completedBgColor;
            timerData.timerDiv.style.color = completedTextColor;
            timerData.timerDiv.style.fontSize = completedFontSize;
            timerData.timerDiv.style.borderColor = 'transparent';
            timerData.timerDiv.style.boxShadow = 'none';
            timerData.isPaused = true;
            timerData.timerDiv.classList.add('timer-completed');

            timerData.timerDiv.style.top = '20%';
            timerData.timerDiv.style.right = '9px';
            timerData.timerDiv.style.left = 'auto';
            timerData.timerDiv.style.transform = 'translateY(-50%)';
            timerData.timerDiv.style.width = 'fit-content';
            timerData.timerDiv.style.textAlign = 'center';
            timerData.timerDiv.style.padding = completedPadding;
            timerData.timerDiv.style.borderRadius = completedBorderRadius;
        }

        timerDiv.addEventListener('click', (e) => {
            e.stopPropagation();
            const timerData = conversationTimers.get(conversationEl);
            if (!timerData) return;

            if (timerData.timerDiv.classList.contains('timer-completed')) {
                return;
            }

            if (timerData.isPaused) {
                resumeTimer(conversationEl);
            } else {
                pauseTimer(conversationEl);
            }
        });

        let numberDiv = document.createElement('div');
        numberDiv.className = 'injected-conversation-number';
        numberDiv.style.position = 'absolute';
        numberDiv.style.top = numberTopPosition;
        numberDiv.style.right = numberRightPosition;
        numberDiv.style.left = 'auto';
        numberDiv.style.transform = 'none';
        numberDiv.style.backgroundColor = numberBgColor;
        numberDiv.style.color = numberTextColor;
        numberDiv.style.padding = numberPadding;
        numberDiv.style.borderRadius = numberBorderRadius;
        numberDiv.style.fontSize = numberFontSize;
        numberDiv.style.fontFamily = 'sans-serif';
        numberDiv.style.fontWeight = 'bold';
        numberDiv.style.zIndex = '99999';
        numberDiv.style.width = 'fit-content';
        numberDiv.style.textAlign = 'center';
        numberDiv.style.minWidth = '20px';
        numberDiv.style.border = `1px solid ${numberBorderColor}`;
        numberDiv.style.boxShadow = numberBoxShadow;
        numberDiv.style.display = 'block';
        conversationEl.appendChild(numberDiv);

        const startTime = Date.now();
        const timerData = {
            timerDiv: timerDiv,
            numberDiv: numberDiv,
            startTime: startTime,
            pausedAt: Date.now(),
            timerIntervalId: null,
            isPaused: true
        };
        conversationTimers.set(conversationEl, timerData);

        if (timerData.numberDiv) {
            timerData.numberDiv.remove();
            timerData.numberDiv = null;
        }

        renderTime(timerDiv, 0);
        return timerData;
    }

    function updateConversationNumbers() {
        const existingConversations = Array.from(document.querySelectorAll('div.interaction-group'))
            .filter(el => conversationTimers.has(el));

        existingConversations.sort((a, b) => b.offsetTop - a.offsetTop);

        existingConversations.forEach((conversationEl, index) => {
            const timerData = conversationTimers.get(conversationEl);
            if (timerData && timerData.numberDiv) {
                timerData.numberDiv.textContent = (index + 1).toString();
                timerData.numberDiv.style.backgroundColor = numberBgColor;
                timerData.numberDiv.style.color = numberTextColor;
                timerData.numberDiv.style.fontSize = numberFontSize;
                timerData.numberDiv.style.display = 'block';
                timerData.numberDiv.style.border = `1px solid ${numberBorderColor}`;
                timerData.numberDiv.style.boxShadow = numberBoxShadow;
                timerData.numberDiv.style.right = numberRightPosition;
            }
        });

        conversationTimers.forEach((timerData, conversationEl) => {
            if (!document.body.contains(conversationEl)) {
                if (timerData.numberDiv) {
                    timerData.numberDiv.remove();
                }
                clearInterval(timerData.timerIntervalId);
                conversationTimers.delete(conversationEl);
            }
        });
    }

    function manageActiveTimers() {
        const currentlySelectedConversation = document.querySelector('div.interaction-group.is-selected');

        conversationTimers.forEach((timerData, conversationEl) => {
            if (conversationEl !== currentlySelectedConversation && !timerData.isPaused && !timerData.timerDiv.classList.contains('timer-completed')) {
                pauseTimer(conversationEl);
            }
        });

        if (currentlySelectedConversation) {
            if (!conversationTimers.has(currentlySelectedConversation)) {
                createTimerAndNumberForConversation(currentlySelectedConversation);
            }
            if (!conversationTimers.get(currentlySelectedConversation).timerDiv.classList.contains('timer-completed')) {
                resumeTimer(currentlySelectedConversation);
            }
            currentActiveConversationEl = currentlySelectedConversation;
        } else {
            currentActiveConversationEl = null;
        }
    }

    document.querySelectorAll('.injected-conversation-timer, .injected-conversation-number').forEach(el => el.remove());
    conversationTimers.clear();

    setTimeout(() => {
        const initialConversationElements = document.querySelectorAll('div.interaction-group');
        if (initialConversationElements.length === 0) {
            console.warn("Nenhum elemento de conversa encontrado na carga inicial.");
        } else {
            initialConversationElements.forEach(createTimerAndNumberForConversation);
        }
        updateConversationNumbers();
        manageActiveTimers();
    }, 500);

    const conversationsListContainer = document.body;
    const observer = new MutationObserver((mutationsList, observer) => {
        let shouldUpdateNumbers = false;
        let shouldManageTimers = false;

        for (const mutation of mutationsList) {
            if (mutation.type === 'childList') {
                if (mutation.addedNodes.length > 0) {
                    for (const node of mutation.addedNodes) {
                        if (node.nodeType === 1) {
                            if (node.matches('div.interaction-group')) {
                                createTimerAndNumberForConversation(node);
                                shouldUpdateNumbers = true;
                                shouldManageTimers = true;
                            }
                            const newConversationElements = node.querySelectorAll('div.interaction-group');
                            newConversationElements.forEach(newConvEl => {
                                if (!conversationTimers.has(newConvEl)) {
                                    createTimerAndNumberForConversation(newConvEl);
                                    shouldUpdateNumbers = true;
                                    shouldManageTimers = true;
                                }
                            });
                        }
                    }
                }
                if (mutation.removedNodes.length > 0) {
                    for (const node of mutation.removedNodes) {
                        if (node.nodeType === 1 && node.matches('div.interaction-group')) {
                            removeTimer(node);
                            shouldUpdateNumbers = true;
                            shouldManageTimers = true;
                        }
                    }
                }
            }

            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                const changedElement = mutation.target;
                if (changedElement.matches('div.interaction-group')) {
                    shouldManageTimers = true;
                }
            }
        }
        if (shouldUpdateNumbers) {
            updateConversationNumbers();
        }
        if (shouldManageTimers) {
            manageActiveTimers();
        }
    });

    observer.observe(conversationsListContainer, { childList: true, subtree: true, attributes: true, attributeFilter: ['class'] });

    console.log("Script Timer OK.");
})();

// =================================================================
// PARTE 2: HELPER SUITE (COR DO BOT√ÉO AJUSTADA PARA MAIS CLARO)
// =================================================================
(function() {
    'use strict';

    // ==================== CONFIGURATION ====================
    const CONFIG = {
        WATCHER_INTERVAL_MS: 1000,
        IFRAME_SRC: "https://apps.sae1.pure.cloud/messaging-gadget/messaging-gadget.html",

        DOC_SEARCH: {
            SELECTORS: {
                iframe_chatContainer: '[data-automation-id="message-history"]',
                iframe_messageBody: '[data-automation-id="messaging-gadget-message-textbody"]',
                iframe_systemMessage: 'p[data-automation-id="message-history-system-message"]',
            },
            CLASSES: {
                button: 'doc-search-btn-v3'
            }
        },

        COMBINED_COPY: {
            SELECTORS: {
                main_actionsContainer: '.actions-container',
                main_originalCopyButton: '.copy-action-button',
                main_participantName: '#interaction-header-participant-name',
            },
            CLASSES: {
                button: 'combined-copy-btn-v3'
            }
        }
    };

    // ==================== STYLES ====================
    const STYLES = `
        #copy-feedback-toast-v3 {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background-color: #28a745; color: white; padding: 12px 20px;
            border-radius: 8px; z-index: 10001; font-family: Arial, sans-serif;
            font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            opacity: 0; pointer-events: none; transition: opacity 0.3s, bottom 0.3s;
        }
    `;

    // ==================== UTILITIES ====================

    class DocumentValidator {
        static validateCPF(cpf) {
            const cleanCPF = String(cpf).replace(/\D/g, '');
            if (cleanCPF.length !== 11 || /^(\d)\1{10}$/.test(cleanCPF)) return false;
            let sum = 0;
            for (let i = 0; i < 9; i++) sum += parseInt(cleanCPF.charAt(i)) * (10 - i);
            let remainder = (sum * 10) % 11;
            if (remainder === 10) remainder = 0;
            if (remainder !== parseInt(cleanCPF.charAt(9))) return false;
            sum = 0;
            for (let i = 0; i < 10; i++) sum += parseInt(cleanCPF.charAt(i)) * (11 - i);
            remainder = (sum * 10) % 11;
            if (remainder === 10) remainder = 0;
            return remainder === parseInt(cleanCPF.charAt(10));
        }

        static validateCNPJ(cnpj) {
            const cleanCNPJ = String(cnpj).replace(/\D/g, '');
            if (cleanCNPJ.length !== 14 || /^(\d)\1{13}$/.test(cleanCNPJ)) return false;
            const weights1 = [5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2];
            let sum = 0;
            for (let i = 0; i < 12; i++) sum += parseInt(cleanCNPJ.charAt(i)) * weights1[i];
            let remainder = sum % 11;
            remainder = remainder < 2 ? 0 : 11 - remainder;
            if (remainder !== parseInt(cleanCNPJ.charAt(12))) return false;
            const weights2 = [6, 5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2];
            sum = 0;
            for (let i = 0; i < 13; i++) sum += parseInt(cleanCNPJ.charAt(i)) * weights2[i];
            remainder = sum % 11;
            remainder = remainder < 2 ? 0 : 11 - remainder;
            return remainder === parseInt(cleanCNPJ.charAt(13));
        }

        static findDocuments(text) {
            if (typeof text !== 'string' || !text) return [];
            const documents = new Map();
            const docRegex = /(?:\b\d{2}\.?\d{3}\.?\d{3}\/?\d{4}-?\d{2}\b)|(?:\b\d{3}\.?\d{3}\.?\d{3}[-.]?\d{2}\b)/g;
            const matches = text.match(docRegex) || [];
            for (const match of matches) {
                const cleanMatch = match.replace(/\D/g, '');
                if (cleanMatch.length === 11) {
                    if (!documents.has(cleanMatch) && this.validateCPF(cleanMatch)) {
                        documents.set(cleanMatch, { type: 'CPF', formatted: this.formatCPF(cleanMatch) });
                    }
                } else if (cleanMatch.length === 14) {
                    if (!documents.has(cleanMatch) && this.validateCNPJ(cleanMatch)) {
                        documents.set(cleanMatch, { type: 'CNPJ', formatted: this.formatCNPJ(cleanMatch) });
                    }
                }
            }
            return Array.from(documents.values());
        }

        static formatCPF(cpf) { return String(cpf).replace(/\D/g, '').replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4'); }
        static formatCNPJ(cnpj) { return String(cnpj).replace(/\D/g, '').replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5'); }
    }

    class UIManager {
        constructor() {
            this.popupContainer = null;
            this.feedbackTimeout = null;
        }

        createPopup(title, bodyElement, borderColor = '#007bff') {
            this.removePopup();
            this.popupContainer = document.createElement('div');
            const backdrop = document.createElement('div');
            backdrop.style.cssText = `position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;`;
            const modal = document.createElement('div');
            modal.style.cssText = `position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; border:2px solid ${borderColor}; border-radius:10px; padding:20px; box-shadow:0 4px 20px rgba(0,0,0,0.3); z-index:10000; max-width:400px; max-height:500px; overflow-y:auto; font-family:Arial,sans-serif;`;
            
            const header = document.createElement('div');
            header.style.cssText = `display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;`;
            const heading = document.createElement('h3');
            heading.textContent = title;
            heading.style.cssText = `margin:0; color:${borderColor};`;
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '√ó';
            closeBtn.style.cssText = `background:#dc3545; color:white; border:none; border-radius:50%; width:30px; height:30px; cursor:pointer; font-size:16px; display:flex; align-items:center; justify-content:center;`;
            
            closeBtn.addEventListener('click', () => this.removePopup());
            backdrop.addEventListener('click', () => this.removePopup());
            
            header.appendChild(heading);
            header.appendChild(closeBtn);
            modal.appendChild(header);
            modal.appendChild(bodyElement);
            this.popupContainer.appendChild(backdrop);
            this.popupContainer.appendChild(modal);
            document.body.appendChild(this.popupContainer);
        }

        showDocumentsPopup(documents) {
            const listContainer = document.createElement('div');
            documents.forEach(doc => {
                const isCPF = doc.type === 'CPF';
                const docElement = document.createElement('div');
                docElement.style.cssText = `margin-bottom:10px; padding:10px; background:${isCPF ? '#e3f2fd' : '#f3e5f5'}; border-radius:5px; border-left:4px solid ${isCPF ? '#2196f3' : '#9c27b0'}; display:flex; justify-content:space-between; align-items:center;`;
                
                const textContainer = document.createElement('div');
                textContainer.innerHTML = `<strong style="color:${isCPF ? '#1976d2' : '#7b1fa2'}">${doc.type}: </strong><span style="font-family:monospace">${doc.formatted}</span>`;
                
                const copyBtn = document.createElement('button');
                copyBtn.textContent = 'üìã Copiar';
                copyBtn.style.cssText = `background:#28a745; color:white; border:none; border-radius:4px; padding:5px 10px; cursor:pointer; font-size:12px;`;
                copyBtn.addEventListener('click', () => this.copyToClipboard(doc.formatted, copyBtn, false));
                
                docElement.append(textContainer, copyBtn);
                listContainer.appendChild(docElement);
            });
            this.createPopup(`üìÑ Documentos (${documents.length})`, listContainer);
        }

        async copyToClipboard(text, buttonElement = null, closeModal = false) {
            try {
                if (!text) throw new Error('Vazio');
                await navigator.clipboard.writeText(text);
                this.showFeedbackToast('‚úÖ Copiado!');
            } catch {
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                ta.remove();
                this.showFeedbackToast('‚úÖ Copiado!');
            }

            if (buttonElement) {
                const originalText = buttonElement.textContent;
                buttonElement.textContent = '‚úÖ';
                buttonElement.style.backgroundColor = '#17a2b8';
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.style.backgroundColor = '#28a745';
                    if (closeModal) this.removePopup();
                }, 1000);
            } else if (closeModal) {
                setTimeout(() => this.removePopup(), 1000);
            }
        }

        showFeedbackToast(message) {
            if (this.feedbackTimeout) clearTimeout(this.feedbackTimeout);
            let feedbackEl = document.getElementById('copy-feedback-toast-v3');
            if (!feedbackEl) {
                feedbackEl = document.createElement('div');
                feedbackEl.id = 'copy-feedback-toast-v3';
                document.body.appendChild(feedbackEl);
            }
            feedbackEl.textContent = message;
            setTimeout(() => {
                feedbackEl.style.opacity = '1';
                feedbackEl.style.bottom = '30px';
                feedbackEl.style.pointerEvents = 'auto';
            }, 10);
            this.feedbackTimeout = setTimeout(() => {
                feedbackEl.style.opacity = '0';
                feedbackEl.style.bottom = '20px';
                feedbackEl.style.pointerEvents = 'none';
            }, 3000);
        }

        showErrorPopup(msg) { this.showInfoPopup('Erro', msg, '‚ùå', '#dc3545'); }
        showNoDocumentsPopup() { this.showInfoPopup('Vazio', 'Sem documentos v√°lidos.', '‚ö†Ô∏è', '#ffc107'); }
        
        showInfoPopup(title, message, icon, color) {
            const body = document.createElement('div');
            body.style.textAlign = 'center';
            body.innerHTML = `<div style="font-size:48px">${icon}</div><p>${message}</p>`;
            this.createPopup(title, body, color);
        }
        
        removePopup() { this.popupContainer?.remove(); this.popupContainer = null; }
    }

    class ChatProcessor {
        constructor(iframeDocument, uiManager) {
            this.iframeDoc = iframeDocument;
            this.uiManager = uiManager;
        }

        async findAndProcessDocuments() {
            try {
                const chatContainer = this.iframeDoc.querySelector(CONFIG.DOC_SEARCH.SELECTORS.iframe_chatContainer);
                if (!chatContainer) throw new Error('Chat n√£o carregado.');
                
                let attempts = 0;
                await new Promise(r => {
                    const i = setInterval(() => {
                          const sysMsg = chatContainer.querySelector(CONFIG.DOC_SEARCH.SELECTORS.iframe_systemMessage);
                          if ((sysMsg && sysMsg.offsetParent) || ++attempts > 20) { clearInterval(i); r(); }
                          else chatContainer.scrollTop = 0;
                    }, 50);
                });
                await new Promise(r => setTimeout(r, 200));

                const msgs = Array.from(chatContainer.querySelectorAll(CONFIG.DOC_SEARCH.SELECTORS.iframe_messageBody))
                                 .map(m => m.textContent).join('\n');
                const docs = DocumentValidator.findDocuments(msgs);
                
                if (docs.length === 1) {
                    await this.uiManager.copyToClipboard(docs[0].formatted);
                    this.uiManager.showFeedbackToast(`Copiado: ${docs[0].formatted}`);
                } else if (docs.length > 1) {
                    this.uiManager.showDocumentsPopup(docs);
                } else {
                    this.uiManager.showNoDocumentsPopup();
                }
            } catch (e) { this.uiManager.showErrorPopup(e.message); }
        }
    }

    class ButtonFactory {
        constructor() {
            this.uiManager = new UIManager();
            this.icons = {
                search: `<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg>`,
                copy: `<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M320-240q-33 0-56.5-23.5T240-320v-480q0-33 23.5-56.5T320-880h480q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H320Zm0-80h480v-480H320v480ZM160-80q-33 0-56.5-23.5T80-160v-560h80v560h560v80H160Zm160-720v480-480Z"/></svg>`,
                loading: `<svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><style>.spinner{transform-origin:center;animation:rot 1.2s linear infinite}.spinner circle{stroke-dasharray:0 150;animation:dash 1.5s ease-in-out infinite}@keyframes rot{100%{transform:rotate(360deg)}}@keyframes dash{0%{stroke-dasharray:0 150;stroke-dashoffset:0}50%{stroke-dasharray:42 150;stroke-dashoffset:-16}100%{stroke-dasharray:42 150;stroke-dashoffset:-59}}</style><g class="spinner"><circle cx="12" cy="12" r="9.5" fill="none" stroke="currentColor" stroke-width="3"></circle></g></svg>`,
                success: `<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M382-240 154-468l57-57 171 171 367-367 57 57-424 424Z"/></svg>`
            };
        }

        // AQUI: Estilos base atualizados para #dae0e5 (mais claro)
        applyBaseStyles(btn) {
            Object.assign(btn.style, {
                cursor: 'pointer', 
                display: 'flex', 
                alignItems: 'center', 
                justifyContent: 'center',
                background: '#dae0e5', // << ALTERADO: Cor mais clara (Cinza suave)
                borderRadius: '4px',
                padding: '5px',
                border: 'none',
                marginLeft: '8px', 
                opacity: '1', 
                transition: '0.2s',
                color: '#263238'
            });
            
            // Hover levemente mais escuro para feedback
            btn.onmouseenter = () => { if(!btn.disabled) btn.style.backgroundColor = '#c8ced3'; };
            btn.onmouseleave = () => { if(!btn.disabled) btn.style.backgroundColor = '#dae0e5'; };
        }

        setButtonState(btn, state, icon, timeout = 0, defaultIcon = null) {
            btn.disabled = (state === 'loading');
            btn.innerHTML = state === 'loading' ? this.icons.loading : icon;
            
            if (state === 'success') {
                btn.style.backgroundColor = '#28a745';
                btn.style.color = '#ffffff'; 
            } else if (state === 'error') {
                btn.style.backgroundColor = '#dc3545';
                btn.style.color = '#ffffff'; 
            } else if (state === 'loading') {
                btn.style.backgroundColor = '#dae0e5'; // Manter a cor clara no loading
                btn.style.color = '#263238';
            } else {
                btn.style.backgroundColor = '#dae0e5'; // Manter a cor clara no estado normal
                btn.style.color = '#263238';
            }

            if (timeout > 0) setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = defaultIcon;
                btn.style.backgroundColor = '#dae0e5'; // Resetar para cor clara
                btn.style.color = '#263238';
            }, timeout);
        }

        createDocSearchButton() {
            const btn = document.createElement('button');
            btn.className = CONFIG.DOC_SEARCH.CLASSES.button;
            btn.title = 'Buscar CPF/CNPJ';
            btn.innerHTML = this.icons.search;
            this.applyBaseStyles(btn);
            
            btn.onclick = async () => {
                const app = window.genesysHelperSuiteInstance;
                const iframes = app ? app.findTargetIframes() : [];
                
                let activeIframe = null;
                for (const frame of iframes) {
                    if (frame.offsetWidth > 0 && frame.offsetHeight > 0) {
                        activeIframe = frame;
                        break;
                    }
                }
                if (!activeIframe) activeIframe = iframes[0];

                if (!activeIframe || !activeIframe.contentDocument) {
                    this.uiManager.showErrorPopup('Chat n√£o encontrado.');
                    return;
                }
                
                this.setButtonState(btn, 'loading');
                await new ChatProcessor(activeIframe.contentDocument, this.uiManager).findAndProcessDocuments();
                this.setButtonState(btn, 'default', this.icons.search);
            };
            return btn;
        }

        createCombinedCopyButton() {
            const btn = document.createElement('button');
            btn.className = CONFIG.COMBINED_COPY.CLASSES.button;
            btn.title = 'Copiar Nome e Protocolo';
            btn.innerHTML = this.icons.copy;
            this.applyBaseStyles(btn);

            btn.onclick = async () => {
                this.setButtonState(btn, 'loading');
                try {
                    const nameEl = document.querySelector(CONFIG.COMBINED_COPY.SELECTORS.main_participantName);
                    if (!nameEl) throw new Error('Nome n√£o encontrado.');
                    const name = nameEl.textContent.trim();

                    let protocol = null;
                    const xpath = "//*[contains(text(), 'Protocolo do contato')]";
                    const result = document.evaluate(xpath, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null);
                    const protocolLabel = result.singleNodeValue;

                    if (protocolLabel) {
                        const text = protocolLabel.textContent;
                        const match = text.match(/Protocolo do contato:\s*(\d+)/);
                        if (match) {
                            protocol = match[1];
                        } else if (protocolLabel.nextElementSibling) {
                             protocol = protocolLabel.nextElementSibling.textContent.trim();
                        } else if (protocolLabel.parentElement) {
                             const parentText = protocolLabel.parentElement.textContent;
                             const matchP = parentText.match(/Protocolo do contato:\s*(\d+)/);
                             if(matchP) protocol = matchP[1];
                        }
                    }

                    if (!protocol) {
                        const originalBtn = document.querySelector(CONFIG.COMBINED_COPY.SELECTORS.main_originalCopyButton);
                        if (originalBtn) {
                            originalBtn.click();
                            await new Promise(r => setTimeout(r, 50)); 
                            protocol = await navigator.clipboard.readText();
                        }
                    }

                    if (!protocol) throw new Error('Protocolo n√£o encontrado.');

                    await navigator.clipboard.writeText(`${name}\n${protocol}`);
                    this.setButtonState(btn, 'success', this.icons.success, 1500, this.icons.copy);

                } catch (e) {
                    console.error(e);
                    this.uiManager.showErrorPopup('Falha ao copiar: ' + e.message);
                    this.setButtonState(btn, 'error', this.icons.copy);
                }
            };
            return btn;
        }
    }

    class GenesysHelperSuite {
        constructor() { this.bf = new ButtonFactory(); }
        init() {
            if (typeof GM_addStyle === 'function') GM_addStyle(STYLES);
            else { const s = document.createElement("style"); s.innerText = STYLES; document.head.appendChild(s); }
            this.startWatcher();
        }

        findTargetIframes(root = document) {
            let res = [];
            root.querySelectorAll('iframe').forEach(f => { if(f.src.startsWith(CONFIG.IFRAME_SRC)) res.push(f); });
            root.querySelectorAll('*').forEach(el => { if(el.shadowRoot) res = res.concat(this.findTargetIframes(el.shadowRoot)); });
            return res;
        }

        injectButtons() {
            const container = document.querySelector(CONFIG.COMBINED_COPY.SELECTORS.main_actionsContainer);
            if (!container) return;

            if (!container.querySelector(`.${CONFIG.DOC_SEARCH.CLASSES.button}`)) {
                container.appendChild(this.bf.createDocSearchButton());
            }

            if (!container.querySelector(`.${CONFIG.COMBINED_COPY.CLASSES.button}`)) {
                container.appendChild(this.bf.createCombinedCopyButton());
            }
            
            const docBtn = container.querySelector(`.${CONFIG.DOC_SEARCH.CLASSES.button}`);
            const copyBtn = container.querySelector(`.${CONFIG.COMBINED_COPY.CLASSES.button}`);
            if (docBtn && copyBtn && docBtn.nextElementSibling !== copyBtn) {
                container.appendChild(copyBtn);
            }
        }

        startWatcher() {
            const obs = new MutationObserver(() => this.injectButtons());
            obs.observe(document.body, { childList: true, subtree: true });
            setInterval(() => this.injectButtons(), 1500);
        }
    }

    const app = new GenesysHelperSuite();
    window.genesysHelperSuiteInstance = app;
    app.init();
})();




// ==UserScript==
// @name Genesys Helper Suite & Timer
// @namespace http://your-domain.com/
// @version 4.0
// @description Sistema unificado: Pausas autom√°ticas.
// @author AI Assistant
// @match *://*/*
// @grant GM_addStyle
// =================================================================
// Parceiro de Programa√ß√£o: FUS√ÉO EST√ÅVEL (V56.12 + Persist√™ncia Total)
// Descri√ß√£o: V56.11 + Salva se a automa√ß√£o est√° ON/OFF e recupera
// o timer/status atual ap√≥s recarregar a p√°gina (F5).
// =================================================================

(function() {

    // --- IN√çCIO: KILL SWITCH ---
    try {
        const ids = ['pausa-script-container', 'pausa-script-config-container', 'pausa-script-drag-overlay'];
        ids.forEach(id => { const el = document.getElementById(id); if(el) el.remove(); });
    } catch (e) { console.warn(e); }
    // --- FIM: KILL SWITCH ---

    // ----------------------------------------------------
    // CONSTANTES E CONFIGURA√á√ïES
    // ----------------------------------------------------
    const SELECTORES = {
        MENU_STATUS_TOGGLE: '#toggleUserDropdownTarget',
        DISPONIVEL: 'button.presence-available',
        REFEICAO: 'button.presence-meal',
        INTERVALO_MENU: 'button.presence-break', 
        OCUPADO_MENU: 'button.presence-busy',    
        LOGOFF: 'span.menu-label', 
        NA_FILA_TOGGLE_HOST: 'gux-toggle#command-bar-queue-toggle', 
        NA_FILA_DIRETO: 'gux-button.onQueueButton',
        VOLTAR_SUBMENU: 'button[title="Volte √†s presen√ßas prim√°rias"]',
        STATUS_LABEL_TEXT: 'span.presence-label-text', 
        TREINAMENTO: 'button.presence-training',
        REUNIAO: 'button.presence-meeting',
    };

    const PAUSAS_AGENDADAS_DEFAULT = [
        { hora: "10:40", status: "Na fila" }, { hora: "11:55", status: "Pausa out" },
        { hora: "12:00", status: "Pausa auricular" }, { hora: "12:10", status: "Na fila" },
        { hora: "13:25", status: "Pausa out" }, { hora: "13:30", status: "Refei√ß√£o" },
        { hora: "13:50", status: "Na fila" }, { hora: "15:15", status: "Pausa out" },
        { hora: "15:20", status: "Pausa auricular" }, { hora: "15:30", status: "Na fila" },
        { hora: "17:00", status: "Logoff" }
    ];

    // --- Vari√°veis de Controle ---
    let estadoAtual = { tipo: 'Dispon√≠vel', inicio: new Date(), ativa: false };
    let isAgendamentoAtivo = false;
    let schedulerInterval = null;
    let syncTimeout = null;
    let ultimoEventoProcessado = null;
    let isConfigPainelAberto = false;
    let isAutomacaoPausada = false;
    let globalWasDragging = false; 

    // --- Chaves de Armazenamento ---
    const STORAGE_KEY_HORARIOS = 'gerenciadorPausas_horarios';
    const STORAGE_KEY_HISTORICO = 'gerenciadorPausas_historicoLog';
    const STORAGE_KEY_POS_MAIN = 'gerenciadorPausas_posMain';
    const STORAGE_KEY_POS_CONFIG = 'gerenciadorPausas_posConfig';
    const STORAGE_KEY_NOTIF_CONFIG = 'gerenciadorPausas_notifConfig';
    // NOVAS CHAVES PARA PERSIST√äNCIA DE ESTADO
    const STORAGE_KEY_ESTADO_ATUAL = 'gerenciadorPausas_estadoAtual_v2'; 
    const STORAGE_KEY_AUTOMACAO_ATIVA = 'gerenciadorPausas_automacaoAtiva';

    const NOTIF_CONFIG_DEFAULT = { ativadas: true, somAtivado: false, antecedenciaSegundos: 15 };
    let configNotificacao = { ...NOTIF_CONFIG_DEFAULT };
    const SOM_NOTIFICACAO_URL = 'https://www.soundjay.com/button/sounds/beep-07a.mp3';
    let audioNotificacao = new Audio(SOM_NOTIFICACAO_URL);
    let audioDesbloqueado = false;

    // --- Fun√ß√µes de LocalStorage ---
    function salvarHorariosLocalStorage(h){try{localStorage.setItem(STORAGE_KEY_HORARIOS,JSON.stringify(h))}catch(e){}}
    function carregarHorariosLocalStorage(){try{const h=localStorage.getItem(STORAGE_KEY_HORARIOS);if(h){const p=JSON.parse(h);if(Array.isArray(p))return p;}}catch(e){}return[...PAUSAS_AGENDADAS_DEFAULT]}
    
    function salvarHistoricoLocalStorage(h){try{localStorage.setItem(STORAGE_KEY_HISTORICO,JSON.stringify(h))}catch(e){}}
    function carregarHistoricoLocalStorage(){try{const h=localStorage.getItem(STORAGE_KEY_HISTORICO);if(h){const p=JSON.parse(h);if(Array.isArray(p))return p;}}catch(e){}return []}

    function salvarPosicaoPainelLocalStorage(k,el){if(!el)return;try{let p={};if(el.style.top&&el.style.left){p={top:el.style.top,left:el.style.left}}else{const r=el.getBoundingClientRect();p={bottom:'30px',right:'30px'}}localStorage.setItem(k,JSON.stringify(p))}catch(e){}}
    function carregarPosicaoPainelLocalStorage(k){try{const pS=localStorage.getItem(k);if(pS)return JSON.parse(pS)}catch(e){}return null}
    function salvarConfiguracoesNotificacaoLocalStorage(c){try{localStorage.setItem(STORAGE_KEY_NOTIF_CONFIG,JSON.stringify(c))}catch(e){}}
    function carregarConfiguracoesNotificacaoLocalStorage(){try{const cS=localStorage.getItem(STORAGE_KEY_NOTIF_CONFIG);if(cS)return{...NOTIF_CONFIG_DEFAULT,...JSON.parse(cS)}}catch(e){}return{...NOTIF_CONFIG_DEFAULT}}
    
    // --- Novas Fun√ß√µes de Persist√™ncia de Estado ---
    function salvarEstadoAtualLocalStorage() {
        try {
            // Salva o timestamp do inicio para recalcular a dura√ß√£o correta
            const dataSalvar = {
                tipo: estadoAtual.tipo,
                inicioMs: estadoAtual.inicio.getTime(),
                ativa: estadoAtual.ativa
            };
            localStorage.setItem(STORAGE_KEY_ESTADO_ATUAL, JSON.stringify(dataSalvar));
        } catch(e) {}
    }

    function salvarStatusAutomacaoLocalStorage(ativo) {
        try { localStorage.setItem(STORAGE_KEY_AUTOMACAO_ATIVA, JSON.stringify(ativo)); } catch(e){}
    }

    function recuperarEstadoInicial() {
        // 1. Recuperar Automa√ß√£o
        try {
            const autoSalva = localStorage.getItem(STORAGE_KEY_AUTOMACAO_ATIVA);
            if (autoSalva) {
                const isAtivo = JSON.parse(autoSalva);
                // A fun√ß√£o toggleAgendamento inverte o valor, ent√£o definimos o oposto antes de chamar ou chamamos logicamente
                // Vamos definir direto e iniciar se for true
                if (isAtivo) {
                    toggleAgendamento(true); // For√ßa ligar sem inverter
                }
            }
        } catch(e) {}

        // 2. Recuperar Status Timer
        try {
            const estadoSalvo = localStorage.getItem(STORAGE_KEY_ESTADO_ATUAL);
            if (estadoSalvo) {
                const dados = JSON.parse(estadoSalvo);
                const agora = new Date().getTime();
                // Se o estado salvo for muito antigo (ex: mais de 12 horas), ignoramos
                if (agora - dados.inicioMs < 43200000) { 
                    estadoAtual = {
                        tipo: dados.tipo,
                        inicio: new Date(dados.inicioMs),
                        ativa: dados.ativa
                    };
                }
            }
        } catch(e) {}
    }

    let PAUSAS_AGENDADAS = carregarHorariosLocalStorage();
    let historicoPausas = carregarHistoricoLocalStorage(); 
    configNotificacao = carregarConfiguracoesNotificacaoLocalStorage();

    // ----------------------------------------------------
    // FUN√á√ïES DE UTILIDADE E INTERA√á√ÉO
    // ----------------------------------------------------
    function tocarSomNotificacao(){if(!configNotificacao.somAtivado)return;if(!audioDesbloqueado){desbloquearAudio(true);return}audioNotificacao.currentTime=0;audioNotificacao.play().catch(e=>{})}
    function desbloquearAudio(forcePlay=!1){if(audioDesbloqueado&&!forcePlay)return;let p=audioNotificacao.play();if(p!==undefined){p.then(()=>{audioNotificacao.pause();audioNotificacao.currentTime=0;if(!audioDesbloqueado){audioDesbloqueado=!0}}).catch(e=>{});}if(audioDesbloqueado){document.removeEventListener('click',desbloquearAudio)}}
    async function mostrarNotificacao(evento){if(!configNotificacao.ativadas)return;if(!("Notification"in window))return;let p=Notification.permission;if(p==="granted"){tocarSomNotificacao();new Notification("Gerenciador",{body:`${evento.status} √†s ${evento.hora}`,tag:`gdp-${evento.hora}`})}else if(p==="default"){try{p=await Notification.requestPermission();if(p==="granted")mostrarNotificacao(evento)}catch(e){}}}
    
    function clicarElemento(s, t = null) {
        let e = null;
        if (t) {
            const l = document.querySelectorAll(s); 
            for (const o of l) {
                if (o.textContent.trim().toLowerCase() === t.toLowerCase()) {
                    e = o;
                    while (e && e.parentElement && e.tagName !== 'BUTTON') e = e.parentElement;
                    if (e && e.tagName === 'BUTTON') break; 
                    e = null;
                }
            }
        } else { e = document.querySelector(s); }
        
        if (e) {
            const c = new MouseEvent('click', { view: window, bubbles: true, cancelable: true });
            e.dispatchEvent(c);
            return true;
        }
        return false;
    }
    
    function clicarVoltarSubmenu(){if(clicarElemento(SELECTORES.VOLTAR_SUBMENU))return!0;return!1}
    function formatarDuracao(s){const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),c=Math.max(0,s%60);const p=n=>String(n).padStart(2,'0');return`${p(h)}:${p(m)}:${p(c)}`}
    function converterDuracaoParaSegundos(d){if(!d||typeof d!=='string')return 0;const p=d.split(':');if(p.length!==3)return 0;const h=parseInt(p[0],10)||0,m=parseInt(p[1],10)||0,s=parseInt(p[2],10)||0;return(h*3600)+(m*60)+s}
    
    function registrarPausa(n){
        const a=new Date;
        if(estadoAtual.ativa){
            const f=a; const d=f.getTime()-estadoAtual.inicio.getTime();
            if(d>500){ 
                historicoPausas.push({
                    tipo:estadoAtual.tipo,
                    inicio:estadoAtual.inicio.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),
                    fim:f.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),
                    duracao:formatarDuracao(Math.round(d/1000))
                });
                salvarHistoricoLocalStorage(historicoPausas); 
                renderizarHistoricoLog(); renderizarEstatisticas();
            }
        } 
        estadoAtual={ tipo:n, inicio:a, ativa: (n !== 'Logoff') };
        salvarEstadoAtualLocalStorage(); // SALVA O STATUS ATUAL
        atualizarUI();
    }
    
    function adicionarAtalho(){document.addEventListener('keydown',function(e){const c=e.ctrlKey||e.metaKey,s=e.shiftKey,o=e.key==='1';if(document.activeElement&&['INPUT','TEXTAREA'].includes(document.activeElement.tagName))return;if(c&&s&&o){e.preventDefault();toggleVisibilidade()}})}

    // --- Agendamento ---
    function mapearEexecutarAcao(s){
        console.log(`[AGENDAMENTO] A√ß√£o Autom√°tica: ${s}`);
        const status = s.toLowerCase().trim();
        switch(status){
            case"na fila": iniciarNaFila(true); break;
            case"dispon√≠vel": voltarDisponivel(true); break;
            case"pausa out": iniciarPausaOut(true); break;
            case"pausa auricular": 
            case"pausa pessoal":
            case"descanso": iniciarDescanso(true); break;
            case"refei√ß√£o": iniciarRefeicao(true); break;
            case"treinamento": iniciarTreinamento(true); break;
            case"reuni√£o": iniciarReuniao(true); break;
            case"logoff": realizarLogoff(true); break;
            case"atividade backoffice":
            case"ativ. backoffice":
            case"backoffice": iniciarBackoffice(true); break;
            case"feedback": iniciarFeedback(true); break;
            case"particular": iniciarParticular(true); break;
            case"quest√µes de sa√∫de":
            case"sa√∫de":
            case"saude": iniciarQuestoesSaude(true); break;
            default: console.warn(`Status '${s}' desconhecido.`);
        }
    }
    
    function verificarEExecutarAgendamentos(){if(!isAgendamentoAtivo||isAutomacaoPausada)return; const a=new Date,h=`${String(a.getHours()).padStart(2,'0')}:${String(a.getMinutes()).padStart(2,'0')}`,s=a.getSeconds(); Object.keys(window).forEach(k=>{if(k.startsWith('notif_')){const e=k.split('_')[1];if(e<h){clearTimeout(window[k]);delete window[k];}}}); const eA=PAUSAS_AGENDADAS.find(p=>p.hora===h);if(eA && ultimoEventoProcessado !== h){mapearEexecutarAcao(eA.status);ultimoEventoProcessado = h;if(eA.status.toLowerCase()==='logoff'){setTimeout(()=>{if(isAgendamentoAtivo)toggleAgendamento()},500)}return} if(!eA && ultimoEventoProcessado) { ultimoEventoProcessado = null; } if (s < 15) {const pM=new Date(a.getTime()+6e4),hP=`${String(pM.getHours()).padStart(2,'0')}:${String(pM.getMinutes()).padStart(2,'0')}`;const eP=PAUSAS_AGENDADAS.find(p=>p.hora===hP);if(eP){const antecedencia = configNotificacao.antecedenciaSegundos; const sN=Math.max(0,(60-antecedencia)-s),tId=`notif_${eP.hora}_${eP.status}`;if(sN>0&&!window[tId]){window[tId]=setTimeout(()=>{mostrarNotificacao(eP);delete window[tId]},sN*1e3)}}}}
    function iniciarSchedulerSincronizado(){if(!isAgendamentoAtivo)return; verificarEExecutarAgendamentos();schedulerInterval=setInterval(verificarEExecutarAgendamentos,60000)}
    function sincronizarEIniciarScheduler(){if(schedulerInterval)clearInterval(schedulerInterval);if(syncTimeout)clearTimeout(syncTimeout);const sA=new Date().getSeconds();const dMs=(60-sA)*1000;syncTimeout=setTimeout(iniciarSchedulerSincronizado,dMs)}
    
    function toggleAgendamento(forceState = null){
        const b=document.getElementById('btn-toggle-agendamento'),p=document.getElementById('btn-pause-resume-agendamento');
        
        // Logica para alternar ou for√ßar estado
        let novoEstado = !isAgendamentoAtivo;
        if (forceState !== null) novoEstado = forceState;

        if(!novoEstado){
            // DESLIGAR
            if(schedulerInterval)clearInterval(schedulerInterval);if(syncTimeout)clearTimeout(syncTimeout);
            schedulerInterval=null;syncTimeout=null;isAgendamentoAtivo=!1;isAutomacaoPausada=!1;
            if(b){b.textContent="Ligar Automa√ß√£o";b.style.background = 'linear-gradient(135deg, #23a745, #2dc24f)';}
            if(p)p.style.display='none';
        }else{
            // LIGAR
            PAUSAS_AGENDADAS=carregarHorariosLocalStorage();
            ultimoEventoProcessado=null;isAutomacaoPausada=!1;isAgendamentoAtivo=!0;
            if(b){b.textContent="Desligar Automa√ß√£o";b.style.background = 'linear-gradient(135deg, #dc3545, #e84a5f)';}
            if(p){
                p.textContent="Pausar ‚è∏Ô∏è";p.style.background = 'linear-gradient(135deg, #ffc107, #ffd25a)';p.style.color = '#000';p.style.display='inline-block';
            }
            sincronizarEIniciarScheduler();
        }
        salvarStatusAutomacaoLocalStorage(isAgendamentoAtivo); // SALVA O STATUS DO BOT√ÉO
        atualizarUI();
    }

    function togglePausaAutomacao(){
        if(!isAgendamentoAtivo)return;
        isAutomacaoPausada=!isAutomacaoPausada;
        const b=document.getElementById('btn-pause-resume-agendamento');
        if(isAutomacaoPausada){
            if(b){b.textContent="Retomar ‚ñ∂Ô∏è";b.style.background = 'linear-gradient(135deg, #007FFF, #009cff)';b.style.color = '#fff';}
        }else{
            if(b){b.textContent="Pausar ‚è∏Ô∏è";b.style.background = 'linear-gradient(135deg, #ffc107, #ffd25a)';b.style.color = '#000';}
            verificarEExecutarAgendamentos();
        }
        atualizarUI();
    }

    function recalcularAgendamentosEmTempoReal() {
        Object.keys(window).forEach(k=>{
            if(k.startsWith('notif_')){ clearTimeout(window[k]); delete window[k]; }
        });
    }

    function adicionarNovoHorario(){
        const iH=document.getElementById('novo-horario-hora'),iS=document.getElementById('novo-horario-status');
        const btn=document.getElementById('btn-adicionar-horario');
        if(!iH||!iS)return;
        const h=iH.value,s=iS.value.trim();
        if(!h||!s)return;
        if(PAUSAS_AGENDADAS.some(p=>p.hora===h)){if(!confirm(`J√° existe ${h}. Substituir?`))return;PAUSAS_AGENDADAS=PAUSAS_AGENDADAS.filter(p=>p.hora!==h)}
        
        PAUSAS_AGENDADAS.push({hora:h,status:s});
        PAUSAS_AGENDADAS.sort((a,b)=>a.hora.localeCompare(b.hora));
        salvarHorariosLocalStorage(PAUSAS_AGENDADAS);
        
        iH.value='';iS.value='';
        renderizarAgendamentos();
        recalcularAgendamentosEmTempoReal();

        if(btn) {
            const txtOriginal = btn.innerHTML;
            btn.innerHTML = "‚úì";
            btn.style.background = "#50fa7b"; 
            setTimeout(() => { 
                btn.innerHTML = txtOriginal; 
                btn.style.background = ""; 
            }, 1000);
        }
    }

    function removerHorario(idx){
        if(idx<0||idx>=PAUSAS_AGENDADAS.length)return;
        if(confirm("Remover este hor√°rio?")){
            PAUSAS_AGENDADAS.splice(idx,1);
            salvarHorariosLocalStorage(PAUSAS_AGENDADAS);
            renderizarAgendamentos();
            recalcularAgendamentosEmTempoReal();
        }
    }
    
    function carregarHorarioParaEdicao(idx){if(idx<0||idx>=PAUSAS_AGENDADAS.length)return;const item=PAUSAS_AGENDADAS[idx];const iH=document.getElementById('novo-horario-hora'),iS=document.getElementById('novo-horario-status');if(!iH||!iS)return;iH.value=item.hora;iS.value=item.status;iS.focus();iS.select()}

    function exportarConfiguracoes(){try{const c={pausas:carregarHorariosLocalStorage(),notificacoes:carregarConfiguracoesNotificacaoLocalStorage(),posicoes:{main:carregarPosicaoPainelLocalStorage(STORAGE_KEY_POS_MAIN),config:carregarPosicaoPainelLocalStorage(STORAGE_KEY_POS_CONFIG)}};const d="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(c,null,2));const l=document.createElement('a');l.setAttribute('href',d);l.setAttribute('download','config_gerenciador_pausas.json');document.body.appendChild(l);l.click();l.remove();}catch(e){alert("Erro ao exportar.")}}
    function importarConfiguracoes(){const i=document.getElementById('import-file-input');if(i)i.click()}
    function handleArquivoImportado(event){const a=event.target.files[0];if(!a)return;const r=new FileReader();r.onload=function(e){try{const c=JSON.parse(e.target.result);if(c&&c.pausas){salvarHorariosLocalStorage(c.pausas);salvarConfiguracoesNotificacaoLocalStorage(c.notificacoes||NOTIF_CONFIG_DEFAULT);salvarPosicaoPainelLocalStorage(STORAGE_KEY_POS_MAIN,c.posicoes?.main);salvarPosicaoPainelLocalStorage(STORAGE_KEY_POS_CONFIG,c.posicoes?.config);alert("Importado com sucesso! Recarregue a p√°gina.");}}catch(err){alert("Arquivo inv√°lido.")}};r.readAsText(a)}

    const DELAY_ABRIR_MENU = 700; const DELAY_ABRIR_SUBMENU = 500; const DELAY_FECHAR_MENU = 200;
    
    function verificarEVoltarDoSubmenu() {
        if (clicarElemento(SELECTORES.VOLTAR_SUBMENU)) return true;
        const botoes = document.querySelectorAll('button');
        for (const b of botoes) {
            if (b.offsetParent === null) continue;
            const txt = b.textContent.trim();
            if (txt.includes('Ocupado') && (txt.includes('<') || b.querySelector('gux-icon'))) {
                b.click(); return true;
            }
        }
        return false;
    }

    function executarLogicaMenuSimples(seletorBotao, nomePausa, isAutomatico = false) {
        if (verificarEVoltarDoSubmenu()) {
            setTimeout(() => executarLogicaMenuSimples(seletorBotao, nomePausa, isAutomatico), 800);
            return;
        }
        if (clicarElemento(SELECTORES.MENU_STATUS_TOGGLE)) {
            setTimeout(() => {
                if (!clicarElemento(seletorBotao)) {
                    clicarElemento(SELECTORES.MENU_STATUS_TOGGLE);
                }
            }, DELAY_ABRIR_MENU);
        }
    }
    
    function executarLogicaSubMenu(seletorMenuTexto, seletorItemTexto, nomePausa, isAutomatico = false) {
        if (verificarEVoltarDoSubmenu()) {
            setTimeout(() => executarLogicaSubMenu(seletorMenuTexto, seletorItemTexto, nomePausa, isAutomatico), 800);
            return;
        }
         if (clicarElemento(SELECTORES.MENU_STATUS_TOGGLE)) {
            setTimeout(() => {
                const seletorMenuBotao = SELECTORES.STATUS_LABEL_TEXT; 
                if (clicarElemento(seletorMenuBotao, seletorMenuTexto)) { 
                    setTimeout(() => {
                        if (clicarElemento(SELECTORES.STATUS_LABEL_TEXT, seletorItemTexto)) {
                             setTimeout(clicarVoltarSubmenu, DELAY_FECHAR_MENU);
                        } else {
                             clicarElemento(SELECTORES.VOLTAR_SUBMENU); 
                             setTimeout(clicarElemento, DELAY_FECHAR_MENU, SELECTORES.MENU_STATUS_TOGGLE);
                        }
                    }, DELAY_ABRIR_SUBMENU);
                } else {
                        clicarElemento(SELECTORES.MENU_STATUS_TOGGLE);
                }
            }, DELAY_ABRIR_MENU);
        }
    }

    function executarLogicaNaFila(isAutomatico = false) {
        let clicado = false; 
        let elDireto = document.querySelector(SELECTORES.NA_FILA_DIRETO);
        if (elDireto && elDireto.offsetHeight !== 0) {
            try{ elDireto.click(); clicado = true; } catch(e){ clicado = clicarElemento(SELECTORES.NA_FILA_DIRETO); }
        } else {
            try {
                const guxToggle = document.querySelector(SELECTORES.NA_FILA_TOGGLE_HOST);
                if (guxToggle && guxToggle.shadowRoot) {
                    const slider = guxToggle.shadowRoot.querySelector('div[role="checkbox"]'); 
                    if (slider) { slider.click(); clicado = true; } 
                }
            } catch (e) {}
        }
    }
    
    function executarLogicaRefeicao(isAutomatico = false){ executarLogicaMenuSimples(SELECTORES.REFEICAO, 'Refei√ß√£o', isAutomatico); }
    function executarLogicaDisponivel(isAutomatico = false){ executarLogicaMenuSimples(SELECTORES.DISPONIVEL, 'Dispon√≠vel', isAutomatico); }
    function executarLogicaTreinamento(isAutomatico = false){ executarLogicaMenuSimples(SELECTORES.TREINAMENTO, 'Treinamento', isAutomatico); }
    function executarLogicaReuniao(isAutomatico = false){ executarLogicaMenuSimples(SELECTORES.REUNIAO, 'Reuni√£o', isAutomatico); }
    function executarLogicaDescanso(isAutomatico = false){ executarLogicaSubMenu("Intervalo", "Pausa auricular", "Pausa auricular", isAutomatico); }
    function executarLogicaPausaOut(isAutomatico = false){ executarLogicaSubMenu("Ocupado", "Pausa out", "Pausa out", isAutomatico); }
    function executarLogicaBackoffice(isAutomatico = false){ executarLogicaSubMenu("Ocupado", "Atividade backoffice", "Backoffice", isAutomatico); }
    function executarLogicaFeedback(isAutomatico = false){ executarLogicaSubMenu("Ocupado", "Feedback", "Feedback", isAutomatico); }
    function executarLogicaParticular(isAutomatico = false){ executarLogicaSubMenu("Ausente", "Particular", "Particular", isAutomatico); }
    function executarLogicaQuestoesSaude(isAutomatico = false){ executarLogicaSubMenu("Ausente", "Quest√µes de sa√∫de", "Sa√∫de", isAutomatico); }

    function executarLogicaLogoff(isAutomatico = false) {
        if (!isAutomatico && !confirm("Fazer logoff? Hist√≥rico ser√° zerado.")) return;
        if (clicarElemento(SELECTORES.MENU_STATUS_TOGGLE)) {
            setTimeout(() => {
                if (clicarElemento(SELECTORES.LOGOFF, "Fazer logoff")) {
                    historicoPausas=[];
                    salvarHistoricoLocalStorage([]); 
                    estadoAtual={tipo:'Logoff',inicio:new Date,ativa:!1};
                    salvarEstadoAtualLocalStorage(); // Atualiza estado
                    atualizarUI();renderizarHistoricoLog();renderizarEstatisticas();
                    if(isAgendamentoAtivo) toggleAgendamento();
                } else {
                    clicarElemento(SELECTORES.MENU_STATUS_TOGGLE);
                }
            }, DELAY_ABRIR_MENU);
        }
    }

    function iniciarNaFila(isAutomatico = false){ registrarPausa("Na fila"); executarLogicaNaFila(isAutomatico); }
    function iniciarRefeicao(isAutomatico = false){ registrarPausa("Refei√ß√£o"); executarLogicaRefeicao(isAutomatico); }
    function voltarDisponivel(isAutomatico = false){ registrarPausa("Dispon√≠vel"); executarLogicaDisponivel(isAutomatico); }
    function iniciarTreinamento(isAutomatico = false){ registrarPausa("Treinamento"); executarLogicaTreinamento(isAutomatico); }
    function iniciarReuniao(isAutomatico = false){ registrarPausa("Reuni√£o"); executarLogicaReuniao(isAutomatico); }
    function iniciarDescanso(isAutomatico = false){ registrarPausa("Pausa auricular"); executarLogicaDescanso(isAutomatico); }
    function iniciarPausaOut(isAutomatico = false){ registrarPausa("Pausa out"); executarLogicaPausaOut(isAutomatico); }
    function iniciarBackoffice(isAutomatico = false){ registrarPausa("Backoffice"); executarLogicaBackoffice(isAutomatico); }
    function iniciarFeedback(isAutomatico = false){ registrarPausa("Feedback"); executarLogicaFeedback(isAutomatico); }
    function iniciarParticular(isAutomatico = false){ registrarPausa("Particular"); executarLogicaParticular(isAutomatico); }
    function iniciarQuestoesSaude(isAutomatico = false){ registrarPausa("Sa√∫de"); executarLogicaQuestoesSaude(isAutomatico); }
    function realizarLogoff(isAutomatico = false){ executarLogicaLogoff(isAutomatico); }

    function criarDragOverlay() {
        if(document.getElementById('pausa-script-drag-overlay')) return;
        const o = document.createElement('div');
        o.id = 'pausa-script-drag-overlay';
        o.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:999999;display:none;cursor:grabbing;';
        document.body.appendChild(o);
        return o;
    }

    function setupGPUDrag(elementId, headerId, storageKey) {
        const element = document.getElementById(elementId);
        const header = document.getElementById(headerId);
        const icone = document.getElementById('pausa-script-icone');
        const overlay = document.getElementById('pausa-script-drag-overlay');
        
        if (!element || !header || !overlay) return;

        let isDragging = false;
        let isRealMovement = false; 
        let startX, startY;
        let initialLeft, initialTop;
        let currentX, currentY; 
        let rAF = null; 
        
        function updatePosition() {
            if (!isDragging || !isRealMovement) return;
            element.style.transform = `translate3d(${currentX}px, ${currentY}px, 0)`;
            rAF = requestAnimationFrame(updatePosition);
        }

        function onPointerDown(e) {
            const isHeader = header.contains(e.target);
            const isIcon = (icone && icone.contains(e.target) && icone.style.display !== 'none');
            
            if (!isHeader && !isIcon) return;

            e.preventDefault();
            isDragging = true;
            isRealMovement = false; 
            
            startX = e.clientX;
            startY = e.clientY;
            currentX = 0;
            currentY = 0;
            
            const rect = element.getBoundingClientRect();
            initialLeft = rect.left;
            initialTop = rect.top;
            
            if (header) header.style.cursor = 'grabbing';
            if (icone) icone.style.cursor = 'grabbing';
            if (isIcon) element.style.cursor = 'grabbing';

            document.addEventListener('mousemove', onPointerMove, { passive: false });
            document.addEventListener('mouseup', onPointerUp);
        }

        function onPointerMove(e) {
            if (!isDragging) return;
            e.preventDefault();

            const dx = e.clientX - startX;
            const dy = e.clientY - startY;

            if (!isRealMovement) {
                if (Math.hypot(dx, dy) < 5) return;
                isRealMovement = true;
                
                element.style.bottom = 'auto';
                element.style.right = 'auto';
                element.style.left = initialLeft + 'px';
                element.style.top = initialTop + 'px';
                element.style.transition = 'none';
                element.style.willChange = 'transform';
                
                element.style.cursor = 'grabbing';
                if (header) header.style.cursor = 'grabbing';
                if (icone) icone.style.cursor = 'grabbing';
                
                overlay.style.display = 'block'; 
                rAF = requestAnimationFrame(updatePosition);
            }
            currentX = dx;
            currentY = dy;
        }

        function onPointerUp(e) {
            if (!isDragging) return;
            isDragging = false;

            if (rAF) cancelAnimationFrame(rAF);

            if (isRealMovement) {
                const finalLeft = initialLeft + currentX;
                const finalTop = initialTop + currentY;
                const maxLeft = window.innerWidth - element.offsetWidth;
                const maxTop = window.innerHeight - element.offsetHeight;
                const boundedLeft = Math.max(0, Math.min(finalLeft, maxLeft));
                const boundedTop = Math.max(0, Math.min(finalTop, maxTop));

                element.style.transform = '';
                element.style.willChange = 'auto';
                element.style.left = boundedLeft + 'px';
                element.style.top = boundedTop + 'px';
                
                overlay.style.display = 'none';
                salvarPosicaoPainelLocalStorage(storageKey, element);
                
                globalWasDragging = true;
                setTimeout(() => { globalWasDragging = false; }, 100);
            } else {
                globalWasDragging = false;
            }

            element.style.cursor = 'default';
            if (header) header.style.cursor = 'pointer';
            if (icone) icone.style.cursor = 'pointer';
            
            const conteudo = document.getElementById('pausa-script-conteudo');
            if (elementId === 'pausa-script-container' && conteudo && conteudo.style.display === 'none') {
                 element.style.cursor = 'pointer';
            }

            document.removeEventListener('mousemove', onPointerMove);
            document.removeEventListener('mouseup', onPointerUp);
        }

        if (header) header.addEventListener('mousedown', onPointerDown);
        if (icone) icone.addEventListener('mousedown', onPointerDown);
    }

    function toggleVisibilidade() {
        const c=document.getElementById('pausa-script-container'),o=document.getElementById('pausa-script-conteudo'),i=document.getElementById('pausa-script-icone');
        if(!c||!o||!i)return;
        
        c.style.transform = 'none';

        const m=15;
        if (o.style.display !== 'none') {
            o.style.display = 'none'; i.style.display = 'flex';
            c.style.width = 'auto'; c.style.padding = '4px 8px'; c.style.cursor = 'pointer'; c.style.fontFamily = "'Courier New', Courier, monospace"; 
            c.style.background='linear-gradient(145deg, rgba(20, 25, 35, 0.9), rgba(30, 35, 50, 0.95))'; 
        } else {
            o.style.display = 'block'; i.style.display = 'none';
            const lE = 300; c.style.width = lE + 'px'; c.style.padding = '15px'; c.style.cursor = 'default'; c.style.fontFamily = "'Segoe UI',Tahoma,Geneva,Verdana,sans-serif"; 
            c.style.background='linear-gradient(145deg, rgba(25, 30, 40, 0.9), rgba(35, 40, 55, 0.95))'; 
            const h = c.querySelector('#pausa-script-header'); if (h) h.style.cursor = 'pointer';
            if(c.style.top&&c.style.left){let cT=parseInt(c.style.top,10),cL=parseInt(c.style.left,10);setTimeout(()=>{const hE=c.offsetHeight;const mL=window.innerWidth-lE-m;if(cL>mL){c.style.left=mL+'px'}if(cL<m){c.style.left=m+'px'}const mT=window.innerHeight-hE-m;if(cT>mT){c.style.top=mT+'px'}if(cT<m){c.style.top=m+'px'}},10)}
            else { const r=c.getBoundingClientRect();c.style.left=r.left+'px';c.style.top=r.top+'px';c.style.bottom = ''; c.style.right = ''; }
        }
    }
    
    function toggleVisibilidadeConfig(){const c=document.getElementById('pausa-script-config-container');if(!c)return;isConfigPainelAberto=!isConfigPainelAberto;c.style.display=isConfigPainelAberto?'block':'none';if(isConfigPainelAberto){renderizarAgendamentos();renderizarHistoricoLog();renderizarEstatisticas()}}
    function renderizarAgendamentos(){const l=document.getElementById('agendamento-lista');if(!l)return; l.innerHTML='';if(PAUSAS_AGENDADAS.length===0){l.innerHTML='<p style="color:#999;margin:5px 0;font-size:11px;text-align:center;">Nenhum hor√°rio agendado.</p>'}else{const r=document.createDocumentFragment();PAUSAS_AGENDADAS.forEach((p,idx)=>{const i=document.createElement('div');i.style.cssText=`display:flex;justify-content:space-between;align-items:center;border-bottom:1px dashed #ffffff15;padding:4px 2px;font-size:11px;`;const tD=document.createElement('div');tD.style.flexGrow='1';tD.innerHTML=`<strong>${p.hora}</strong>: ${p.status}`;const bD=document.createElement('div');bD.style.flexShrink='0';bD.style.marginLeft='10px'; const bE=document.createElement('button');bE.innerHTML='‚úèÔ∏è';bE.title=`Editar ${p.hora}`;bE.style.cssText=`background:0 0;border:none;color:#ffc107;cursor:pointer;font-size:14px;padding:0 4px;opacity:.7;transition:opacity .2s;`;bE.onmouseover=function(){this.style.opacity='1'};bE.onmouseout=function(){this.style.opacity='.7'};bE.onclick=()=>carregarHorarioParaEdicao(idx); const bR=document.createElement('button');bR.innerHTML='‚ùå';bR.title=`Remover ${p.hora}`;bR.style.cssText=`background:0 0;border:none;color:#ff6b6b;cursor:pointer;font-size:14px;padding:0 4px;margin-left:5px;opacity:.7;transition:opacity .2s;`;bR.onmouseover=function(){this.style.opacity='1'};bE.onmouseout=function(){this.style.opacity='.7'};bR.onclick=()=>removerHorario(idx); bD.appendChild(bE);bD.appendChild(bR);i.appendChild(tD);i.appendChild(bD);r.appendChild(i)});l.appendChild(r)}}
    function renderizarHistoricoLog(){const l=document.getElementById('historico-log');if(!l)return; l.innerHTML='';if(historicoPausas.length===0){l.innerHTML='<p style="color:#999;margin:5px 0;font-size:11px;">Nenhum registro.</p>';return} const f=document.createDocumentFragment();historicoPausas.slice().reverse().forEach(p=>{const i=document.createElement('div');i.style.cssText=`border-bottom:1px dashed #ffffff15;padding:4px 0;font-size:11px;line-height:1.4;`;i.innerHTML=`<strong>${p.tipo}</strong>: ${p.inicio} √†s ${p.fim} <span style="color:#00b0ff;">(Dur: ${p.duracao})</span>`;f.appendChild(i)});l.appendChild(f);}
    function renderizarEstatisticas(){const s=document.getElementById('estatisticas-pausas');if(!s)return; s.innerHTML='';if(historicoPausas.length===0){s.innerHTML='<p style="color:#999;font-style:italic;margin:5px 0;font-size:11px;">Sem estat√≠sticas.</p>';return} const r={};historicoPausas.forEach(p=>{const t=p.tipo;if(!r[t])r[t]={c:0,s:0};r[t].c++;r[t].s+=converterDuracaoParaSegundos(p.duracao)}); const d=document.createElement('details');d.style.marginTop='10px';d.open=!0; const m=document.createElement('summary');m.style.cssText='cursor:pointer;color:#00b0ff;font-weight:700;margin-bottom:5px;';m.textContent='Estat√≠sticas';d.appendChild(m); const c=document.createElement('div');c.style.cssText=`background-color:#00000040;padding:8px;border-radius:8px;font-size:11px;`; const f=document.createDocumentFragment();const k=Object.keys(r).sort();k.forEach((t,x)=>{const o=r[t];const u=formatarDuracao(o.s);const i=document.createElement('div');i.style.cssText=`display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px dashed #ffffff15;line-height:1.4;`;if(x===k.length-1)i.style.borderBottom='none';i.innerHTML=`<strong>${t} (x${o.c})</strong> <span style="color:#00b0ff;">${u}</span>`;f.appendChild(i)}); c.appendChild(f);d.appendChild(c);s.appendChild(d);}
    function verificarSeletoresEAtualizarUI(){const rD=document.getElementById('seletores-resultados'); if(!rD)return; rD.innerHTML='<p style="font-style:italic;color:#bbb;">Verificando...</p>'; let hR='<ul style="list-style:none;padding:0;margin:5px 0 0 0;font-size:11px;">';setTimeout(()=>{Object.keys(SELECTORES).forEach(k=>{const s=SELECTORES[k]; const e=document.querySelector(s);const f=e!==null&&(e.offsetParent!==null||e.tagName==='DIV'||e.tagName==='SPAN'); hR+=`<li style="padding:3px 0;border-bottom:1px dashed #ffffff15;display:flex;justify-content:space-between;align-items:center;"><span style="color:#ccc; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${k}:</span><span><code style="font-size:10px;background-color:rgba(0,255,255,.1);border:1px solid rgba(0,255,255,.2);color:#9fefef;padding:1px 3px;border-radius:3px; max-width: 120px; display: inline-block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${s}</code><span style="margin-left:8px;font-weight:700;color:${f?'#50fa7b':'#ff5555'};">${f?'Ok':'Fail'}</span></span></li>`;});hR+='</ul>';rD.innerHTML=hR},50)}

    // --- CRIAR UI PRINCIPAL (VISUAL N√çTIDO) ---
    function criarUI() {
        const cId='pausa-script-container';let cA=document.getElementById(cId);if(cA)cA.remove(); const c=document.createElement('div');c.id=cId;document.body.appendChild(c);
        const pS=carregarPosicaoPainelLocalStorage(STORAGE_KEY_POS_MAIN);
        let cssPos = `position:fixed; ${pS ? (pS.top ? `top:${pS.top};left:${pS.left};` : `bottom:${pS.bottom};right:${pS.right};`) : 'bottom:30px;right:30px;'}`;
        
        c.style.cssText = `${cssPos} width:auto;height:auto;color:#E0E0E0;font-family:'Courier New',Courier,monospace;padding:4px 8px;border-radius:10px;border:1px solid rgba(0,255,255,0.3);background:linear-gradient(145deg, rgba(20, 25, 35, 0.9), rgba(30, 35, 50, 0.95));box-shadow:0 8px 20px rgba(0,0,0,0.5),0 0 10px rgba(0,255,255,0.1);backdrop-filter:blur(10px);z-index:2147483647;cursor:pointer;user-select:none;transition:box-shadow .2s;box-sizing:border-box;will-change:transform;`;
        
        c.innerHTML=`<style>
            #${cId} *{box-sizing:border-box}
            #${cId} .script-btn{display:flex;align-items:center;justify-content:center;gap:10px;padding:10px 15px;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;color:#FFFFFF;text-shadow:0 1px 2px rgba(0,0,0,0.3);background-image:none;box-shadow:0 3px 5px rgba(0,0,0,0.3),inset 0 1px 1px rgba(255,255,255,0.1);transition:all 0.15s ease-out;width:100%}
            #${cId} .script-btn:hover{filter:brightness(1.1);transform:translateY(-2px)}
            #${cId} .script-btn:active{transform:translateY(1px);filter:brightness(0.95)}
            #${cId} #btn-disponivel,#${cId} #btn-toggle-agendamento[style*="rgb(35, 167, 69)"]{background:linear-gradient(135deg,#23a745,#2dc24f)}
            #${cId} #btn-toggle-agendamento[style*="rgb(220, 53, 69)"]{background:linear-gradient(135deg,#dc3545,#e84a5f)}
            #${cId} #btn-pause-resume-agendamento[style*="rgb(255, 193, 7)"]{background:linear-gradient(135deg,#ffc107,#ffd25a);color:#000}
            #${cId} #btn-pause-resume-agendamento[style*="rgb(0, 127, 255)"]{background:linear-gradient(135deg,#007FFF,#009cff);color:#fff}
            #${cId} #btn-na-fila{background:linear-gradient(135deg,#0096C7,#00bfff)}
            #${cId} #btn-refeicao{background:linear-gradient(135deg,#fd7e14,#ff9a40)}
            #${cId} #btn-descanso{background:linear-gradient(135deg,#ffc107,#ffd25a);color:#000}
            #${cId} #btn-pausa-out{background:linear-gradient(135deg,#e63946,#f45b69)}
            #${cId} #btn-treinamento{background:linear-gradient(135deg,#6a00c9,#8e2de2)}
            #${cId} #btn-backoffice{background:linear-gradient(135deg,#c94b4b,#d46a6a)}
            #${cId} #btn-feedback{background:linear-gradient(135deg,#e85d04,#fa7e30)}
            #${cId} #btn-particular{background:linear-gradient(135deg,#8338ec,#9f60f0)}
            #${cId} #btn-saude{background:linear-gradient(135deg,#5e60ce,#7b7de0)}
            #${cId} #btn-reuniao{background:linear-gradient(135deg,#00c9c9,#30dede);color:#000}
            #${cId} #btn-logoff{background:linear-gradient(135deg,#6c757d,#868e96)}
            #${cId} #pausa-script-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(0,255,255,0.2);cursor:pointer}
            #${cId} #pausa-script-header h3{color:#0FF;margin:0;font-size:16px;font-weight:600}
            #${cId} #pausa-script-header span#btn-abrir-config{cursor:pointer;color:#0FF;font-size:20px;margin-right:12px}
            #${cId} #pausa-script-header span#btn-minimizar{cursor:pointer;color:#e63946;font-size:16px;font-weight:700}
            #${cId} #status-display{background-color:rgba(0,0,0,0.2);border:1px solid rgba(0,0,0,0.3);color:#FFF;padding:10px;border-radius:8px;margin-bottom:15px;text-align:center;font-size:14px}
            #${cId} #current-status{font-weight:700}
            #${cId} #pausa-script-icone{display:flex;align-items:center;justify-content:center;gap:6px;width:100%;height:100%;cursor:pointer}
            #${cId} #top-bar-time{font-size:1.5em;font-weight:700;white-space:nowrap;color:#e63946;text-shadow:none;line-height:1;display:block;padding-top:4px;}
            #${cId} #pausa-script-clock-dot{width:8px;height:8px;background-color:#e63946;border-radius:50%;animation:blink-animation 1.5s infinite ease-in-out;box-shadow:none;flex-shrink:0;}
            @keyframes blink-animation{0%{opacity:1}50%{opacity:0.3}100%{opacity:1}}
            </style>
        
            <div id="pausa-script-icone"><span id="pausa-script-clock-dot" style="display:none;"></span><span id="top-bar-time">--:--:--</span></div>
            <div id="pausa-script-conteudo" style="display:none;padding:0;">
                <div id="pausa-script-header">
                    <h3>üõ†Ô∏è Gerenciador</h3>
                    <div style="display:flex;align-items:center;gap:12px;">
                        <span id="pausa-script-header-clock" style="font-size:15px;font-family:'Courier New',Courier,monospace;color:#f1fa8c;line-height:1;">--:--:--</span>
                        <div style="flex-shrink:0;"><span id="btn-abrir-config" title="Configura√ß√µes">‚öôÔ∏è</span><span id="btn-minimizar" title="Fechar Painel">[X]</span></div>
                    </div>
                </div>
                <div id="status-display">Status: <strong id="current-status" style="color:#50fa7b;">${estadoAtual.tipo}</strong></div>
                <div style="margin-bottom:15px;">
                    <button id="btn-toggle-agendamento" class="script-btn">Ligar Automa√ß√£o</button>
                    <button id="btn-pause-resume-agendamento" class="script-btn" style="display:none; margin-top: 8px;">Pausar ‚è∏Ô∏è</button>
                </div>
                <div id="buttons-container" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:10px;">
                    <button id="btn-disponivel" class="script-btn">üü¢ Dispon√≠vel</button>
                    <button id="btn-na-fila" class="script-btn">üéß Na Fila</button>
                    <button id="btn-refeicao" class="script-btn">üçî Refei√ß√£o</button>
                    <button id="btn-descanso" class="script-btn">‚òï Pausa auricular</button>
                    <button id="btn-pausa-out" class="script-btn">‚õî Pausa Out</button>
                    <button id="btn-treinamento" class="script-btn">üìö Treinamento</button>
                    <button id="btn-backoffice" class="script-btn">üìÅ Backoffice</button>
                    <button id="btn-feedback" class="script-btn">üìù Feedback</button>
                    <button id="btn-particular" class="script-btn">üöΩ Particular</button>
                    <button id="btn-saude" class="script-btn">ü©∫ Sa√∫de</button>
                </div>
                <div id="buttons-extra" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                    <button id="btn-reuniao" class="script-btn">üßë‚Äçü§ù‚Äçüßë Reuni√£o</button>
                    <button id="btn-logoff" class="script-btn">üö™ Fazer Logoff</button>
                </div>
            </div>`;
        
        criarDragOverlay(); 
        setupGPUDrag('pausa-script-container', 'pausa-script-header', STORAGE_KEY_POS_MAIN);

        c.addEventListener('click',function(e){
            if (globalWasDragging) return;
            
            const t=e.target.closest('button'),n=e.target.closest('span#btn-minimizar, span#btn-abrir-config'),o=e.target.closest('div#pausa-script-icone');let l=t||n||o;if(!l)return; 
            const d=document.getElementById('pausa-script-conteudo');
            if (o && d && d.style.display==='none'){ toggleVisibilidade(); return; }
            const a=document.getElementById('pausa-script-header');
            if (d.style.display!=='none'&&a&&a.contains(e.target)&&!n&&!t)return;
            
            const i=l.id;switch(i){
                case'btn-na-fila':iniciarNaFila(false);break; 
                case'btn-refeicao':iniciarRefeicao(false);break;
                case'btn-descanso':iniciarDescanso(false);break; 
                case'btn-pausa-out':iniciarPausaOut(false);break;
                case'btn-disponivel':voltarDisponivel(false);break; 
                case'btn-logoff':realizarLogoff(false);break;
                case'btn-treinamento':iniciarTreinamento(false);break; 
                case'btn-reuniao':iniciarReuniao(false);break;
                case'btn-backoffice':iniciarBackoffice(false);break;
                case'btn-feedback':iniciarFeedback(false);break;
                case'btn-particular':iniciarParticular(false);break;
                case'btn-saude':iniciarQuestoesSaude(false);break;
                case'btn-toggle-agendamento':toggleAgendamento();break; 
                case'btn-pause-resume-agendamento':togglePausaAutomacao();break;
                case'btn-minimizar':toggleVisibilidade();break; 
                case'btn-abrir-config':toggleVisibilidadeConfig();break;
            }
        });
        
        const bTg=c.querySelector('#btn-toggle-agendamento'),bP=c.querySelector('#btn-pause-resume-agendamento');
        if(bTg&&bP){
            if(isAgendamentoAtivo){
                bTg.textContent="Desligar Automa√ß√£o";bTg.style.background = 'linear-gradient(135deg, #dc3545, #e84a5f)';bP.style.display='block';
                if(isAutomacaoPausada){bP.textContent="Retomar ‚ñ∂Ô∏è";bP.style.background = 'linear-gradient(135deg, #007FFF, #009cff)';bP.style.color = '#fff';}
                else{bP.textContent="Pausar ‚è∏Ô∏è";bP.style.background = 'linear-gradient(135deg, #ffc107, #ffd25a)';bP.style.color = '#000';}
            }else{
                bTg.textContent="Ligar Automa√ß√£o";bTg.style.background = 'linear-gradient(135deg, #23a745, #2dc24f)';bP.style.display='none';
            }
        }
        
        // Se acabamos de recuperar o estado, n√£o registramos como 'nova pausa', apenas atualizamos a UI
        atualizarUI();
        adicionarAtalho(); 
        setInterval(atualizarUI,1000);
    }

    // --- CRIAR UI CONFIGURA√á√ïES ---
    function criarUIConfiguracoes() {
        const cId='pausa-script-config-container';let cA=document.getElementById(cId);if(cA)cA.remove(); const cC=document.createElement('div');cC.id=cId;document.body.appendChild(cC); const pSC=carregarPosicaoPainelLocalStorage(STORAGE_KEY_POS_CONFIG);
        let cssPos = `position:fixed; ${pSC ? (pSC.top ? `top:${pSC.top};left:${pSC.left};` : `bottom:${pSC.bottom};right:${pSC.right};`) : 'bottom:30px;right:340px;'}`;
        
        cC.style.cssText=`${cssPos} width:340px;background:linear-gradient(145deg,rgba(25,30,40,0.9),rgba(35,40,55,0.95));color:#E0E0E0;border:1px solid rgba(0,255,255,.3);border-radius:10px;padding:15px;z-index:2147483646;box-shadow:0 8px 20px rgba(0,0,0,0.5),0 0 10px rgba(0,255,255,0.1);font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;font-size:13px;height:auto;max-height:calc(100vh - 60px);backdrop-filter:blur(10px);transition:box-shadow .2s;display:none;overflow-y:auto;box-sizing:border-box;cursor:default;will-change:transform;`;
        
        cC.innerHTML=`<style>
            #${cId} *{box-sizing:border-box}
            #${cId} .script-btn-config{padding:10px 15px;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,0.3);box-shadow:0 3px 5px rgba(0,0,0,0.3),inset 0 1px 1px rgba(255,255,255,0.1);transition:all .15s ease-out;width:100%}
            #${cId} .script-btn-config:hover{filter:brightness(1.1);transform:translateY(-2px)}
            #${cId} details{margin-top:15px;border:1px solid rgba(0,255,255,.1);border-radius:8px;background-color:rgba(0,0,0,.2)}
            #${cId} summary{padding:10px 12px;cursor:pointer;color:#0FF;font-weight:600;list-style:none;display:flex;align-items:center}
            #${cId} summary::before{content:'‚ñ∂';margin-right:8px;font-size:10px;transition:transform .2s;display:inline-block}
            #${cId} details[open]>summary::before{transform:rotate(90deg)}
            #${cId} details>div{padding:12px;border-top:1px solid rgba(0,255,255,.1)}
            #${cId} .add-schedule-form{display:flex;gap:8px;margin-top:10px;align-items:center}
            #${cId} .add-schedule-form input{background-color:rgba(0,0,0,.3);border:1px solid rgba(0,255,255,.3);color:#E0E0E0;padding:8px;border-radius:6px;font-size:13px}
            #${cId} .add-schedule-form button{flex-shrink:0;padding:8px 14px!important;width:auto!important;background:linear-gradient(135deg,#23a745,#2dc24f)!important;font-weight:700;border:none;border-radius:8px;transition:all 0.3s}
            #${cId} #agendamento-lista{max-height:150px;overflow-y:auto;margin-bottom:10px;border-radius:6px;padding:8px;background-color:rgba(0,0,0,.25)}
            #${cId} #agendamento-lista button{background:0 0;border:none;cursor:pointer;font-size:14px;padding:0 4px;margin-left:5px}
            #${cId} #btn-exportar-config{background:linear-gradient(135deg,#007FFF,#009cff);border:none}
            #${cId} #btn-importar-config{background:linear-gradient(135deg,#6c757d,#868e96);border:none}
            #${cId} #btn-verificar-seletores{background:linear-gradient(135deg,#5a6268,#7a8288);border:none}
            </style>
            
            <div id="pausa-script-config-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:5px;border-bottom:1px solid rgba(0,255,255,.2);cursor:pointer;"><h3 style="margin:0;font-size:15px;">‚öôÔ∏è Config & Hist√≥rico</h3><span id="btn-fechar-config" style="cursor:pointer;color:#e63946;font-weight:700;">[X]</span></div>
            <div id="estatisticas-pausas" style="margin-bottom:0;"></div>
            
            <details><summary>üîî Configurar Notifica√ß√µes</summary><div id="notificacao-config"><div style="display:flex;justify-content:space-between;margin-bottom:8px;"><label for="notif-ativadas">Ativar Visuais:</label><input type="checkbox" id="notif-ativadas"></div><div style="display:flex;justify-content:space-between;margin-bottom:8px;"><label for="notif-som">Ativar Som:</label><input type="checkbox" id="notif-som"></div><div style="display:flex;justify-content:space-between;"><label for="notif-tempo">Anteced√™ncia (s):</label><input type="number" id="notif-tempo" min="5" max="55" step="5" style="width:50px;"></div></div></details>
            <details open><summary>Editar Hor√°rios</summary><div id="agendamento-edit"><div id="agendamento-lista"></div><div class="add-schedule-form"><input type="time" id="novo-horario-hora" required><input type="text" id="novo-horario-status" placeholder="Ex: Refei√ß√£o" required style="flex-grow:1;"><button id="btn-adicionar-horario">+</button></div></div></details>
            <details open><summary>Hist√≥rico de Pausas</summary><div id="historico-log" style="max-height:150px;overflow-y:auto;"></div></details>
            <details><summary>ü©∫ Diagn√≥stico</summary><div id="seletores-check"><button id="btn-verificar-seletores" class="script-btn-config">Verificar Seletores</button><div id="seletores-resultados" style="max-height:150px;overflow-y:auto;margin-top:8px;"></div></div></details>
            <details><summary>üíæ Backup</summary><div id="backup-restore"><div style="display:flex;gap:8px;"><button id="btn-exportar-config" class="script-btn-config">Exportar</button><button id="btn-importar-config" class="script-btn-config">Importar</button></div><input type="file" id="import-file-input" accept=".json" style="display:none;"></div></details>
        `;
        
        setupGPUDrag('pausa-script-config-container', 'pausa-script-config-header', STORAGE_KEY_POS_CONFIG);

        const bF=cC.querySelector('#btn-fechar-config');if(bF)bF.onclick=toggleVisibilidadeConfig;
        const bV=cC.querySelector('#btn-verificar-seletores');if(bV)bV.onclick=verificarSeletoresEAtualizarUI;
        const bA=cC.querySelector('#btn-adicionar-horario');if(bA)bA.onclick=adicionarNovoHorario;
        const cN=cC.querySelector('#notif-ativadas'),cS=cC.querySelector('#notif-som'),iT=cC.querySelector('#notif-tempo');if(cN)cN.checked=configNotificacao.ativadas;if(cS)cS.checked=configNotificacao.somAtivado;if(iT)iT.value=configNotificacao.antecedenciaSegundos;
        function sM(){configNotificacao.ativadas=cN.checked;configNotificacao.somAtivado=cS.checked;let t=parseInt(iT.value,10);if(isNaN(t)||t<5)t=5;if(t>55)t=55;iT.value=t;configNotificacao.antecedenciaSegundos=t;salvarConfiguracoesNotificacaoLocalStorage(configNotificacao);}
        if(cN)cN.onchange=sM;if(cS)cS.onchange=sM;if(iT)iT.onchange=sM;
        const bE=cC.querySelector('#btn-exportar-config');if(bE)bE.onclick=exportarConfiguracoes;
        const bI=cC.querySelector('#btn-importar-config');if(bI)bI.onclick=importarConfiguracoes;
        const fI=cC.querySelector('#import-file-input');if(fI)fI.onchange=handleArquivoImportado;

        renderizarAgendamentos();renderizarHistoricoLog();renderizarEstatisticas();
    }

    // --- L√ìGICA DE CORES N√çTIDAS E AJUSTADAS (V56.12) ---
    function atualizarUI() {
        const a=new Date,h=a.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
        
        const tFlutuante=document.getElementById('top-bar-time');
        const tDot=document.getElementById('pausa-script-clock-dot');
        const tHeader = document.getElementById('pausa-script-header-clock');
        const sDisplay = document.getElementById('current-status');

        const statusLower = estadoAtual.tipo.toLowerCase();
        
        // --- DEFINI√á√ÉO DA COR N√çTIDA ---
        let corFinal = '#ffb347'; 

        if (statusLower === 'dispon√≠vel') {
            corFinal = '#50fa7b'; 
        } else if (statusLower === 'na fila') {
            corFinal = '#40e0ff'; 
        } else if (statusLower.includes('pausa out') || statusLower.includes('backoffice') || statusLower.includes('feedback') || statusLower.includes('limpeza') || statusLower.includes('reuni√£o')) {
            corFinal = '#e63946'; 
        } else if (statusLower === 'logoff') {
            corFinal = '#999';
        }

        // APLICA√á√ÉO VISUAL
        if(tFlutuante){
            tFlutuante.textContent = h;
            tFlutuante.style.color = corFinal;
            tFlutuante.style.textShadow = 'none'; 
        }
        
        if(tHeader) {
            tHeader.textContent = h;
            tHeader.style.color = corFinal;
            tHeader.style.textShadow = 'none'; 
        }

        if (tDot) {
            if (!isAgendamentoAtivo) {
                tDot.style.display = 'none';
            } else {
                tDot.style.display = 'block';
                tDot.style.backgroundColor = corFinal;
                tDot.style.boxShadow = 'none'; 
                
                if (isAutomacaoPausada) {
                    tDot.style.animation = 'none';
                    tDot.style.opacity = '1'; 
                } else {
                    tDot.style.animation = 'blink-animation 1.5s infinite ease-in-out';
                }
            }
        }

        if(sDisplay){
            let e=''; if(estadoAtual.ativa){const o=a.getTime()-estadoAtual.inicio.getTime();e=` (${formatarDuracao(Math.max(0,Math.round(o/1000)))})`;}
            sDisplay.textContent=`${estadoAtual.tipo}${e}`;
            sDisplay.style.color = corFinal;
        }
    }

    // ----------------------------------------------------
    // START
    // ----------------------------------------------------
    console.log("[GERENCIADOR FUS√ÉO] Iniciando (V56.12: Persist√™ncia de Estado)...");
    setTimeout(() => {
        try {
            configNotificacao = carregarConfiguracoesNotificacaoLocalStorage();
            PAUSAS_AGENDADAS = carregarHorariosLocalStorage();
            
            // --- RECUPERA√á√ÉO DE ESTADO ---
            recuperarEstadoInicial();
            
            if (configNotificacao.ativadas && "Notification" in window && Notification.permission === 'default') Notification.requestPermission();
            
            criarUI();
            criarUIConfiguracoes();
            renderizarAgendamentos();
            
            audioNotificacao.volume = 0.5;
            document.addEventListener('click', desbloquearAudio, { once: true });
        } catch (error) { console.error("[GERENCIADOR] Erro:", error); }
    }, 2800);

})();

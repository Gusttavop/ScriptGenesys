// ==UserScript==
// @name Genesys Helper Suite (Fix CPF)
// @namespace http://your-domain.com/
// @version 3.6
// @description Sistema unificado: Cron√¥metro, Busca Doc e C√≥pia Instant√¢nea. Visual Escurecido. Corre√ß√£o de sele√ß√£o de chat ativo.
// @author AI Assistant
// @match *://*/*
// @grant GM_addStyle
// ==/UserScript==

(function() {
    'use strict';

    // ==================== CONFIGURATION ====================
    const CONFIG = {
        WATCHER_INTERVAL_MS: 1500,
        // Parte da URL para identificar iframes de chat
        IFRAME_PARTIAL_SRC: "messaging-gadget", 

        DOC_SEARCH: {
            SELECTORS: {
                // Seletores internos do iframe do chat
                messageBody: '[data-automation-id="messaging-gadget-message-textbody"]',
                systemMessage: 'p[data-automation-id="message-history-system-message"]',
                container: '[data-automation-id="message-history"]'
            },
            CLASSES: {
                button: 'doc-search-btn-v3'
            }
        },

        COMBINED_COPY: {
            SELECTORS: {
                main_actionsContainer: '.actions-container', // Container onde o bot√£o ser√° injetado
                main_originalCopyButton: '.copy-action-button',
            },
            CLASSES: {
                button: 'combined-copy-btn-v3'
            }
        }
    };

    // ==================== STYLES ====================
    // Adiciona estilos via JS puro para garantir que carreguem
    const styleSheet = document.createElement("style");
    styleSheet.textContent = `
        #copy-feedback-toast-v3 {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background-color: #28a745; color: white; padding: 12px 20px;
            border-radius: 8px; z-index: 10001; font-family: Arial, sans-serif;
            font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            opacity: 0; pointer-events: none; transition: opacity 0.3s, bottom 0.3s;
        }
        .doc-search-btn-v3 {
            background-color: #6f42c1; color: white; border: none;
            padding: 5px 10px; border-radius: 4px; margin-left: 8px;
            cursor: pointer; font-weight: bold; font-size: 12px;
        }
        .doc-search-btn-v3:hover { background-color: #5a32a3; }
    `;
    document.head.appendChild(styleSheet);

    // ==================== UTILITIES ====================

    class DocumentValidator {
        static validateCPF(cpf) {
            const cleanCPF = String(cpf).replace(/\D/g, '');
            if (cleanCPF.length !== 11 || /^(\d)\1{10}$/.test(cleanCPF)) return false;
            let sum = 0;
            for (let i = 0; i < 9; i++) sum += parseInt(cleanCPF.charAt(i)) * (10 - i);
            let remainder = (sum * 10) % 11;
            if (remainder === 10) remainder = 0;
            if (remainder !== parseInt(cleanCPF.charAt(9))) return false;
            sum = 0;
            for (let i = 0; i < 10; i++) sum += parseInt(cleanCPF.charAt(i)) * (11 - i);
            remainder = (sum * 10) % 11;
            if (remainder === 10) remainder = 0;
            return remainder === parseInt(cleanCPF.charAt(10));
        }

        static validateCNPJ(cnpj) {
            const cleanCNPJ = String(cnpj).replace(/\D/g, '');
            if (cleanCNPJ.length !== 14 || /^(\d)\1{13}$/.test(cleanCNPJ)) return false;
            const weights1 = [5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2];
            let sum = 0;
            for (let i = 0; i < 12; i++) sum += parseInt(cleanCNPJ.charAt(i)) * weights1[i];
            let remainder = sum % 11;
            remainder = remainder < 2 ? 0 : 11 - remainder;
            if (remainder !== parseInt(cleanCNPJ.charAt(12))) return false;
            const weights2 = [6, 5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2];
            sum = 0;
            for (let i = 0; i < 13; i++) sum += parseInt(cleanCNPJ.charAt(i)) * weights2[i];
            remainder = sum % 11;
            remainder = remainder < 2 ? 0 : 11 - remainder;
            return remainder === parseInt(cleanCNPJ.charAt(13));
        }

        static findDocuments(text) {
            if (typeof text !== 'string' || !text) return [];
            const documents = new Map();
            // Regex ajustada para capturar formatos comuns
            const docRegex = /(?:\b\d{3}\.?\d{3}\.?\d{3}-?\d{2}\b)|(?:\b\d{2}\.?\d{3}\.?\d{3}\/?\d{4}-?\d{2}\b)/g;
            
            const matches = text.match(docRegex) || [];
            
            for (const match of matches) {
                const cleanMatch = match.replace(/\D/g, '');
                
                // Prioridade para CPF (11 d√≠gitos)
                if (cleanMatch.length === 11) {
                    if (!documents.has(cleanMatch) && this.validateCPF(cleanMatch)) {
                        documents.set(cleanMatch, { type: 'CPF', formatted: this.formatCPF(cleanMatch) });
                    }
                } 
                // CNPJ (14 d√≠gitos)
                else if (cleanMatch.length === 14) {
                    if (!documents.has(cleanMatch) && this.validateCNPJ(cleanMatch)) {
                        documents.set(cleanMatch, { type: 'CNPJ', formatted: this.formatCNPJ(cleanMatch) });
                    }
                }
            }
            return Array.from(documents.values());
        }

        static formatCPF(cpf) { return String(cpf).replace(/\D/g, '').replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4'); }
        static formatCNPJ(cnpj) { return String(cnpj).replace(/\D/g, '').replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5'); }
    }

    class UIManager {
        constructor() {
            this.popupContainer = null;
            this.feedbackTimeout = null;
        }

        createPopup(title, bodyElement, borderColor = '#6f42c1') {
            this.removePopup();
            this.popupContainer = document.createElement('div');
            
            // Backdrop
            const backdrop = document.createElement('div');
            backdrop.style.cssText = `position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;`;
            
            // Modal
            const modal = document.createElement('div');
            modal.style.cssText = `position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; border:2px solid ${borderColor}; border-radius:10px; padding:20px; box-shadow:0 4px 20px rgba(0,0,0,0.3); z-index:10000; max-width:400px; max-height:500px; overflow-y:auto; font-family:Arial,sans-serif; min-width: 300px;`;
            
            // Header
            const header = document.createElement('div');
            header.style.cssText = `display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;`;
            
            const heading = document.createElement('h3');
            heading.textContent = title;
            heading.style.cssText = `margin:0; color:${borderColor}; font-size: 16px;`;
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '√ó';
            closeBtn.style.cssText = `background:#dc3545; color:white; border:none; border-radius:50%; width:25px; height:25px; cursor:pointer; font-size:18px; display:flex; align-items:center; justify-content:center; line-height: 1;`;
            
            closeBtn.addEventListener('click', () => this.removePopup());
            backdrop.addEventListener('click', () => this.removePopup());
            
            header.appendChild(heading);
            header.appendChild(closeBtn);
            modal.appendChild(header);
            modal.appendChild(bodyElement);
            this.popupContainer.appendChild(backdrop);
            this.popupContainer.appendChild(modal);
            document.body.appendChild(this.popupContainer);
        }

        removePopup() {
            if (this.popupContainer) {
                this.popupContainer.remove();
                this.popupContainer = null;
            }
        }

        showDocumentsPopup(documents) {
            if (documents.length === 0) {
                this.showFeedbackToast('‚ùå Nenhum documento v√°lido encontrado nesta conversa.');
                return;
            }

            const listContainer = document.createElement('div');
            
            documents.forEach(doc => {
                const isCPF = doc.type === 'CPF';
                const docElement = document.createElement('div');
                docElement.style.cssText = `margin-bottom:10px; padding:10px; background:${isCPF ? '#e3f2fd' : '#f3e5f5'}; border-radius:5px; border-left:4px solid ${isCPF ? '#2196f3' : '#9c27b0'}; display:flex; justify-content:space-between; align-items:center;`;
                
                const textContainer = document.createElement('div');
                textContainer.innerHTML = `<strong style="color:${isCPF ? '#1976d2' : '#7b1fa2'}">${doc.type}: </strong><span style="font-family:monospace; font-size: 14px;">${doc.formatted}</span>`;
                
                const copyBtn = document.createElement('button');
                copyBtn.textContent = 'üìã';
                copyBtn.title = 'Copiar';
                copyBtn.style.cssText = `background:#28a745; color:white; border:none; border-radius:4px; padding:5px 12px; cursor:pointer; font-size:14px; margin-left: 10px;`;
                
                // Closure garante que doc.formatted √© o correto para este bot√£o
                copyBtn.addEventListener('click', () => this.copyToClipboard(doc.formatted, copyBtn, false));
                
                docElement.append(textContainer, copyBtn);
                listContainer.appendChild(docElement);
            });
            this.createPopup(`üìÑ Documentos Encontrados (${documents.length})`, listContainer);
        }

        async copyToClipboard(text, buttonElement = null, closeModal = false) {
            try {
                if (!text) throw new Error('Vazio');
                await navigator.clipboard.writeText(text);
                this.showFeedbackToast('‚úÖ Copiado: ' + text);
            } catch {
                // Fallback
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                ta.remove();
                this.showFeedbackToast('‚úÖ Copiado: ' + text);
            }

            if (buttonElement) {
                const originalText = buttonElement.textContent;
                buttonElement.textContent = '‚úî';
                buttonElement.style.backgroundColor = '#17a2b8';
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.style.backgroundColor = '#28a745';
                    if (closeModal) this.removePopup();
                }, 1000);
            } else if (closeModal) {
                setTimeout(() => this.removePopup(), 1000);
            }
        }

        showFeedbackToast(message) {
            if (this.feedbackTimeout) clearTimeout(this.feedbackTimeout);
            
            let feedbackEl = document.getElementById('copy-feedback-toast-v3');
            if (!feedbackEl) {
                feedbackEl = document.createElement('div');
                feedbackEl.id = 'copy-feedback-toast-v3';
                document.body.appendChild(feedbackEl);
            }
            
            feedbackEl.textContent = message;
            feedbackEl.style.opacity = '1';
            feedbackEl.style.bottom = '50px'; // Sobe um pouco
            
            this.feedbackTimeout = setTimeout(() => {
                feedbackEl.style.opacity = '0';
                feedbackEl.style.bottom = '20px';
            }, 3000);
        }
    }

    // ==================== MAIN LOGIC ====================

    class MainApp {
        constructor() {
            this.ui = new UIManager();
        }

        // CORRE√á√ÉO CR√çTICA: Busca o texto apenas do iframe VIS√çVEL
        getVisibleChatText() {
            // Busca todos os iframes que parecem ser de chat
            const iframes = document.querySelectorAll(`iframe`);
            let activeIframe = null;

            // Filtra pelo iframe que est√° vis√≠vel na tela
            for (const iframe of iframes) {
                // Verifica se o iframe tem tamanho (√© vis√≠vel) E se a URL corresponde a um chat
                if (iframe.offsetWidth > 0 && iframe.offsetHeight > 0) {
                     // Verifica se o source contem o gadget de mensagem, se definido
                     if (iframe.src && iframe.src.includes(CONFIG.IFRAME_PARTIAL_SRC)) {
                         activeIframe = iframe;
                         break; // Assume que s√≥ h√° um chat ativo/vis√≠vel por vez
                     }
                }
            }

            if (!activeIframe) {
                console.warn("Genesys Helper: Nenhum iframe de chat ativo encontrado.");
                return "";
            }

            try {
                const doc = activeIframe.contentDocument || activeIframe.contentWindow.document;
                
                // Raspa mensagens de texto
                const messages = Array.from(doc.querySelectorAll(CONFIG.DOC_SEARCH.SELECTORS.messageBody))
                    .map(el => el.innerText)
                    .join(' ');
                
                // Raspa mensagens de sistema (opcional, √†s vezes o CPF vem do URA)
                const systemMessages = Array.from(doc.querySelectorAll(CONFIG.DOC_SEARCH.SELECTORS.systemMessage))
                    .map(el => el.innerText)
                    .join(' ');

                return messages + " " + systemMessages;
            } catch (e) {
                console.error("Genesys Helper: Erro ao acessar conte√∫do do iframe (Cross-Origin?).", e);
                return "";
            }
        }

        handleDocSearch() {
            const text = this.getVisibleChatText();
            if (!text) {
                this.ui.showFeedbackToast('‚ö†Ô∏è N√£o foi poss√≠vel ler o chat ativo.');
                return;
            }
            const docs = DocumentValidator.findDocuments(text);
            this.ui.showDocumentsPopup(docs);
        }

        injectButtons() {
            // Injeta o bot√£o na barra de a√ß√µes principal se ainda n√£o existir
            // Nota: O seletor .actions-container pode variar dependendo da vers√£o do Genesys.
            // O ideal √© buscar um container comum no cabe√ßalho da intera√ß√£o.
            const containers = document.querySelectorAll(CONFIG.COMBINED_COPY.SELECTORS.main_actionsContainer);
            
            containers.forEach(container => {
                // Verifica se o container est√° vis√≠vel (pertence √† aba ativa)
                if (container.offsetParent !== null && !container.querySelector(`.${CONFIG.DOC_SEARCH.CLASSES.button}`)) {
                    
                    const btn = document.createElement('button');
                    btn.className = CONFIG.DOC_SEARCH.CLASSES.button;
                    btn.textContent = 'üîç Docs';
                    btn.title = 'Buscar CPF/CNPJ na conversa ativa';
                    btn.type = 'button'; // Previne submit de form se houver
                    
                    btn.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.handleDocSearch();
                    };

                    // Adiciona no in√≠cio ou fim do container
                    container.appendChild(btn);
                }
            });
        }

        start() {
            console.log('Genesys Helper Suite iniciado.');
            setInterval(() => {
                this.injectButtons();
            }, CONFIG.WATCHER_INTERVAL_MS);
        }
    }

    // Inicia a aplica√ß√£o
    const app = new MainApp();
    app.start();

})();
